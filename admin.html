<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CMC Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { transition: all 0.3s ease; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: linear-gradient(135deg, #f4f7f6, #e8f0f5); }
        header { background: linear-gradient(135deg, #003366, #004d99); color: white; padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        header h3 { margin: 0; font-size: 1.5rem; }
        .btn-group { display: flex; gap: 10px; }
        .container { padding: 30px 20px; max-width: 1400px; margin: 0 auto; }
        .filters { background: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filters select, .filters input { padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.95rem; }
        .filters select:focus, .filters input:focus { outline: none; border-color: #003366; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-top: 4px solid #ffcc00; }
        .stat-card h4 { margin: 0 0 10px 0; color: #666; font-size: 0.9rem; font-weight: 600; }
        .stat-card .value { font-size: 2.5rem; font-weight: bold; color: #003366; margin: 10px 0; }
        .stat-card .subtext { font-size: 0.85rem; color: #999; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .chart-container h4 { margin: 0 0 15px 0; color: #003366; }
        .chart-inner { position: relative; height: 300px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        th, td { padding: 14px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #003366; color: white; font-weight: 600; }
        tr:hover { background: #f9f9f9; }
        .btn { padding: 10px 16px; border-radius: 6px; cursor: pointer; text-decoration: none; border: none; font-size: 0.9rem; font-weight: 600; }
        .btn-export { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
        .btn-export:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4); }
        .btn-logout { background: linear-gradient(135deg, #dc3545, #e74c3c); color: white; }
        .btn-logout:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4); }
        .rating-badge { padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.85rem; }
        .rating-badge.high { background: #d4edda; color: #155724; }
        .rating-badge.med { background: #fff3cd; color: #856404; }
        .rating-badge.low { background: #f8d7da; color: #721c24; }
        table h4 { margin: 0; }
        .feedback-row { display: flex; gap: 30px; margin-bottom: 30px; }
        .feedback-list { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); flex: 1; }
        .feedback-list h4 { margin-top: 0; }
        .feedback-item { padding: 12px; border-left: 3px solid #ffcc00; background: #f9f9f9; margin-bottom: 10px; border-radius: 4px; }
        .feedback-item .name { font-weight: 600; color: #003366; }
        .feedback-item .roll { font-size: 0.85rem; color: #999; }
        .feedback-item .date { font-size: 0.8rem; color: #bbb; }
        .dropdown-menu { display: none; position: absolute; background: white; border: 2px solid #ddd; border-radius: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 1000; }
        .dropdown-menu.show { display: block; }
        .dropdown-menu a { display: block; padding: 10px 15px; color: #333; text-decoration: none; cursor: pointer; border-bottom: 1px solid #eee; }
        .dropdown-menu a:last-child { border-bottom: none; }
        .dropdown-menu a:hover { background: #f5f5f5; }
    </style>
</head>
<body>
    <header>
        <h3>üìä CMC Mess Admin Dashboard</h3>
        <div class="btn-group">
            <div style="position: relative;">
                <button class="btn btn-export" onclick="toggleExportMenu()">üì• Export Report</button>
                <div id="export-menu" class="dropdown-menu">
                    <a onclick="exportDailyReport()">üìÑ Daily Report</a>
                    <a onclick="exportWeeklyReport()">üìä Weekly Report (7 sheets)</a>
                    <a onclick="exportMonthlyReport()">üìà Monthly Report (30 sheets)</a>
                </div>
            </div>
            <button class="btn btn-logout" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="container">
        <div class="filters">
            <div>
                <label for="period" style="margin-right: 10px; color: #666; font-weight: 600;">Period:</label>
                <select id="period" onchange="updateDashboard()">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
            </div>
            <div style="flex: 1;"></div>
            <div style="font-size: 0.9rem; color: #666;">
                <span id="filter-info">Showing all data</span>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h4>üìã Total Submissions</h4>
                <div class="value" id="total-count">0</div>
                <div class="subtext">feedback responses received</div>
            </div>
            <div class="stat-card">
                <h4>‚≠ê Overall Avg. Rating</h4>
                <div class="value" id="overall-avg">0.0</div>
                <div class="subtext">out of 5 stars</div>
            </div>
            <div class="stat-card">
                <h4>üë• Students Participated</h4>
                <div class="value" id="unique-students">0</div>
                <div class="subtext">unique students</div>
            </div>
            <div class="stat-card">
                <h4>üçΩÔ∏è Items Reviewed</h4>
                <div class="value" id="unique-items">0</div>
                <div class="subtext">different food items</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h4>‚≠ê Average Rating by Criteria</h4>
                <div class="chart-inner">
                    <canvas id="criteriaChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h4>üìà Daily Submissions Trend</h4>
                <div class="chart-inner">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h4>ü•ò Top 10 Items by Average Rating</h4>
                <div class="chart-inner">
                    <canvas id="itemsChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h4>üìä Meal Type Distribution</h4>
                <div class="chart-inner">
                    <canvas id="mealChart"></canvas>
                </div>
            </div>
        </div>

        <div class="feedback-row">
            <div class="feedback-list" style="flex: 2;">
                <h4>üìù Recent Feedback & Submissions</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Roll Number</th>
                            <th>Date & Time</th>
                            <th>Meal</th>
                            <th>Items</th>
                            <th>Avg Rating</th>
                        </tr>
                    </thead>
                    <tbody id="submissions-table"></tbody>
                </table>
            </div>
        </div>

        <h4 style="margin-top: 40px; color: #003366;">üìä Item-wise Analysis</h4>
        <table>
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Submissions</th>
                    <th>Taste</th>
                    <th>Quality</th>
                    <th>Quantity</th>
                    <th>Cleanliness</th>
                    <th>Overall Rating</th>
                </tr>
            </thead>
            <tbody id="analysis-table"></tbody>
        </table>
    </div>

    <script>
        if(sessionStorage.getItem('isAdmin') !== 'true') window.location.href = 'login.html';

        let allData = JSON.parse(localStorage.getItem('cmc_feedback') || '[]');
        let charts = {};

        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

        // Clean up data older than 1 month
        function cleanupOldData() {
            const oneMonthAgo = new Date();
            oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
            
            const initialCount = allData.length;
            allData = allData.filter(sub => new Date(sub.datetime) >= oneMonthAgo);
            
            if (allData.length < initialCount) {
                localStorage.setItem('cmc_feedback', JSON.stringify(allData));
                console.log(`üóëÔ∏è Cleaned up ${initialCount - allData.length} old responses (older than 1 month)`);
            }
        }

        // Run cleanup on dashboard load
        cleanupOldData();

        function getFilteredData() {
            const period = document.getElementById('period').value;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(today);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

            return allData.filter(sub => {
                const subDate = new Date(sub.datetime);
                const subDateOnly = new Date(subDate.getFullYear(), subDate.getMonth(), subDate.getDate());
                if (period === 'today') return subDateOnly.getTime() === today.getTime();
                if (period === 'week') return subDate >= weekStart;
                if (period === 'month') return subDate >= monthStart;
                return true;
            });
        }

        function updateFilterInfo() {
            const period = document.getElementById('period').value;
            const now = new Date();
            const labels = {
                'all': 'Showing all data (last 30 days)',
                'today': `Showing data for ${now.toLocaleDateString()}`,
                'week': `Showing data for the week of ${new Date(now.setDate(now.getDate() - now.getDay())).toLocaleDateString()}`,
                'month': `Showing data for ${now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`
            };
            document.getElementById('filter-info').innerText = labels[period];
        }

        function updateDashboard() {
            updateFilterInfo();
            const data = getFilteredData();
            
            document.getElementById('total-count').innerText = data.length;

            const itemStats = {};
            const studentRolls = new Set();
            const itemNames = new Set();
            let totalScore = 0;
            let scoreCount = 0;

            const dailyStats = {};
            
            data.forEach(sub => {
                studentRolls.add(sub.student_roll);
                sub.items.forEach(item => {
                    itemNames.add(item.item_name);
                    if(!itemStats[item.item_name]) {
                        itemStats[item.item_name] = { count: 0, taste: 0, quality: 0, quantity: 0, cleanliness: 0 };
                    }
                    const s = itemStats[item.item_name];
                    s.count++;
                    s.taste += item.taste;
                    s.quality += item.quality;
                    s.quantity += item.quantity;
                    s.cleanliness += item.cleanliness;

                    totalScore += (item.taste + item.quality + item.quantity + item.cleanliness) / 4;
                    scoreCount++;
                });

                const dateKey = new Date(sub.datetime).toLocaleDateString();
                dailyStats[dateKey] = (dailyStats[dateKey] || 0) + 1;
            });

            document.getElementById('overall-avg').innerText = scoreCount > 0 ? (totalScore / scoreCount).toFixed(1) : "0.0";
            document.getElementById('unique-students').innerText = studentRolls.size;
            document.getElementById('unique-items').innerText = itemNames.size;

            // Update tables
            const tbody = document.getElementById('analysis-table');
            tbody.innerHTML = '';
            Object.keys(itemStats).sort().forEach(name => {
                const s = itemStats[name];
                const avgRating = ((s.taste + s.quality + s.quantity + s.cleanliness) / (s.count * 4)).toFixed(1);
                const ratingClass = avgRating >= 3.5 ? 'high' : avgRating >= 2.5 ? 'med' : 'low';
                const row = `<tr>
                    <td><strong>${name}</strong></td>
                    <td>${s.count}</td>
                    <td><span class="rating-badge ${ratingClass}">${(s.taste / s.count).toFixed(1)}</span></td>
                    <td><span class="rating-badge ${ratingClass}">${(s.quality / s.count).toFixed(1)}</span></td>
                    <td><span class="rating-badge ${ratingClass}">${(s.quantity / s.count).toFixed(1)}</span></td>
                    <td><span class="rating-badge ${ratingClass}">${(s.cleanliness / s.count).toFixed(1)}</span></td>
                    <td><span class="rating-badge ${ratingClass}">${avgRating}</span></td>
                </tr>`;
                tbody.innerHTML += row;
            });

            // Recent submissions
            const submissionsBody = document.getElementById('submissions-table');
            submissionsBody.innerHTML = '';
            const recentData = data.slice().reverse().slice(0, 10);
            recentData.forEach(sub => {
                const itemCount = sub.items.length;
                const avgRating = sub.items.reduce((sum, item) => sum + (item.taste + item.quality + item.quantity + item.cleanliness) / 4, 0) / itemCount;
                const row = `<tr>
                    <td><strong>${sub.student_name || 'N/A'}</strong></td>
                    <td>${sub.student_roll || 'N/A'}</td>
                    <td>${new Date(sub.datetime).toLocaleString()}</td>
                    <td>${sub.meal_type}</td>
                    <td>${itemCount} items</td>
                    <td><span class="rating-badge ${avgRating >= 3.5 ? 'high' : avgRating >= 2.5 ? 'med' : 'low'}">${avgRating.toFixed(1)}</span></td>
                </tr>`;
                submissionsBody.innerHTML += row;
            });

            // Update charts
            updateCharts(data, itemStats, dailyStats);
        }

        function updateCharts(data, itemStats, dailyStats) {
            // Criteria Chart
            const criteriaCtx = document.getElementById('criteriaChart').getContext('2d');
            if (charts.criteria) charts.criteria.destroy();
            charts.criteria = new Chart(criteriaCtx, {
                type: 'bar',
                data: {
                    labels: ['Taste', 'Quality', 'Quantity', 'Cleanliness'],
                    datasets: [{
                        label: 'Average Rating',
                        data: [
                            data.reduce((sum, s) => sum + s.items.reduce((is, i) => is + i.taste, 0), 0) / (data.reduce((sum, s) => sum + s.items.length, 0) || 1),
                            data.reduce((sum, s) => sum + s.items.reduce((is, i) => is + i.quality, 0), 0) / (data.reduce((sum, s) => sum + s.items.length, 0) || 1),
                            data.reduce((sum, s) => sum + s.items.reduce((is, i) => is + i.quantity, 0), 0) / (data.reduce((sum, s) => sum + s.items.length, 0) || 1),
                            data.reduce((sum, s) => sum + s.items.reduce((is, i) => is + i.cleanliness, 0), 0) / (data.reduce((sum, s) => sum + s.items.length, 0) || 1)
                        ],
                        backgroundColor: 'rgba(0, 51, 102, 0.8)',
                        borderColor: 'rgba(0, 51, 102, 1)',
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 5 } } }
            });

            // Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            if (charts.trend) charts.trend.destroy();
            const sortedDates = Object.keys(dailyStats).sort();
            charts.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Submissions per Day',
                        data: sortedDates.map(d => dailyStats[d]),
                        borderColor: 'rgba(255, 204, 0, 1)',
                        backgroundColor: 'rgba(255, 204, 0, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });

            // Items Chart (Top 10)
            const itemsCtx = document.getElementById('itemsChart').getContext('2d');
            if (charts.items) charts.items.destroy();
            const topItems = Object.entries(itemStats)
                .map(([name, s]) => ({ name, avg: (s.taste + s.quality + s.quantity + s.cleanliness) / (s.count * 4) }))
                .sort((a, b) => b.avg - a.avg)
                .slice(0, 10);
            charts.items = new Chart(itemsCtx, {
                type: 'horizontalBar',
                data: {
                    labels: topItems.map(i => i.name),
                    datasets: [{
                        label: 'Average Rating',
                        data: topItems.map(i => i.avg),
                        backgroundColor: 'rgba(0, 51, 102, 0.8)',
                        borderColor: 'rgba(0, 51, 102, 1)',
                        borderWidth: 2
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, max: 5 } } }
            });

            // Meal Chart
            const mealCtx = document.getElementById('mealChart').getContext('2d');
            if (charts.meal) charts.meal.destroy();
            const mealStats = {};
            data.forEach(sub => mealStats[sub.meal_type] = (mealStats[sub.meal_type] || 0) + 1);
            charts.meal = new Chart(mealCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(mealStats),
                    datasets: [{
                        data: Object.values(mealStats),
                        backgroundColor: ['rgba(0, 51, 102, 0.8)', 'rgba(255, 204, 0, 0.8)', 'rgba(100, 150, 200, 0.8)'],
                        borderColor: ['rgba(0, 51, 102, 1)', 'rgba(255, 204, 0, 1)', 'rgba(100, 150, 200, 1)'],
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function exportCSV() {
            const data = getFilteredData();
            let csv = "Date,Time,Student Name,Roll Number,Meal,Item,Taste,Quality,Quantity,Cleanliness,Comment\n";
            data.forEach(sub => {
                sub.items.forEach(i => {
                    csv += `${sub.date_readable},${sub.time_readable},"${sub.student_name}","${sub.student_roll}",${sub.meal_type},"${i.item_name}",${i.taste},${i.quality},${i.quantity},${i.cleanliness},"${i.comment.replace(/"/g, '""')}"\n`;
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cmc_feedback_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function toggleExportMenu() {
            const menu = document.getElementById('export-menu');
            menu.classList.toggle('show');
        }

        document.addEventListener('click', function(e) {
            const menu = document.getElementById('export-menu');
            const btn = e.target.closest('.btn-export');
            if (!btn && menu.classList.contains('show')) {
                menu.classList.remove('show');
            }
        });

        function exportDailyReport() {
            const data = getFilteredData();
            const workbook = XLSX.utils.book_new();
            
            // Group by date
            const byDate = {};
            data.forEach(sub => {
                if (!byDate[sub.date_readable]) byDate[sub.date_readable] = [];
                byDate[sub.date_readable].push(sub);
            });
            
            Object.keys(byDate).sort().forEach(dateKey => {
                const records = [];
                const meals = ['Breakfast', 'Lunch', 'Dinner'];
                
                meals.forEach(mealType => {
                    const mealData = byDate[dateKey].filter(d => d.meal_type === mealType);
                    if (mealData.length > 0) {
                        records.push({ // Header row
                            'Date': dateKey,
                            'Meal Type': mealType,
                            'Student Name': '',
                            'Roll Number': '',
                            'Items Reviewed': '',
                            'Avg Taste': '',
                            'Avg Quality': '',
                            'Avg Quantity': '',
                            'Avg Cleanliness': '',
                            'Overall Rating': ''
                        });
                        
                        mealData.forEach(sub => {
                            const itemCount = sub.items.length;
                            const totals = sub.items.reduce((acc, item) => ({
                                taste: acc.taste + item.taste,
                                quality: acc.quality + item.quality,
                                quantity: acc.quantity + item.quantity,
                                cleanliness: acc.cleanliness + item.cleanliness
                            }), {taste: 0, quality: 0, quantity: 0, cleanliness: 0});
                            
                            records.push({
                                'Date': dateKey,
                                'Meal Type': mealType,
                                'Student Name': sub.student_name,
                                'Roll Number': sub.student_roll,
                                'Items Reviewed': sub.items.map(i => i.item_name).join(', '),
                                'Avg Taste': (totals.taste / itemCount).toFixed(2),
                                'Avg Quality': (totals.quality / itemCount).toFixed(2),
                                'Avg Quantity': (totals.quantity / itemCount).toFixed(2),
                                'Avg Cleanliness': (totals.cleanliness / itemCount).toFixed(2),
                                'Overall Rating': ((totals.taste + totals.quality + totals.quantity + totals.cleanliness) / (itemCount * 4)).toFixed(2)
                            });
                        });
                    }
                });
                
                const ws = XLSX.utils.json_to_sheet(records);
                XLSX.utils.book_append_sheet(workbook, ws, 'Daily Report');
            });
            
            XLSX.writeFile(workbook, `CMC_Daily_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            document.getElementById('export-menu').classList.remove('show');
        }

        function exportWeeklyReport() {
            const data = getFilteredData();
            const workbook = XLSX.utils.book_new();
            
            // Group by date
            const byDate = {};
            data.forEach(sub => {
                if (!byDate[sub.date_readable]) byDate[sub.date_readable] = [];
                byDate[sub.date_readable].push(sub);
            });
            
            const dates = Object.keys(byDate).sort();
            let dayCount = 0;
            
            dates.forEach(dateKey => {
                dayCount++;
                const records = [];
                const meals = ['Breakfast', 'Lunch', 'Dinner'];
                
                meals.forEach(mealType => {
                    const mealData = byDate[dateKey].filter(d => d.meal_type === mealType);
                    if (mealData.length > 0) {
                        records.push({ // Meal header
                            'Date': dateKey,
                            'Meal Type': mealType,
                            'Student Name': '',
                            'Roll Number': '',
                            'Items Reviewed': '',
                            'Avg Taste': '',
                            'Avg Quality': '',
                            'Avg Quantity': '',
                            'Avg Cleanliness': '',
                            'Overall Rating': ''
                        });
                        
                        mealData.forEach(sub => {
                            const itemCount = sub.items.length;
                            const totals = sub.items.reduce((acc, item) => ({
                                taste: acc.taste + item.taste,
                                quality: acc.quality + item.quality,
                                quantity: acc.quantity + item.quantity,
                                cleanliness: acc.cleanliness + item.cleanliness
                            }), {taste: 0, quality: 0, quantity: 0, cleanliness: 0});
                            
                            records.push({
                                'Date': dateKey,
                                'Meal Type': mealType,
                                'Student Name': sub.student_name,
                                'Roll Number': sub.student_roll,
                                'Items Reviewed': sub.items.map(i => i.item_name).join(', '),
                                'Avg Taste': (totals.taste / itemCount).toFixed(2),
                                'Avg Quality': (totals.quality / itemCount).toFixed(2),
                                'Avg Quantity': (totals.quantity / itemCount).toFixed(2),
                                'Avg Cleanliness': (totals.cleanliness / itemCount).toFixed(2),
                                'Overall Rating': ((totals.taste + totals.quality + totals.quantity + totals.cleanliness) / (itemCount * 4)).toFixed(2)
                            });
                        });
                    }
                });
                
                const ws = XLSX.utils.json_to_sheet(records);
                const dayName = new Date(dateKey).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                const sheetName = `Day ${dayCount} (${dayName})`;
                XLSX.utils.book_append_sheet(workbook, ws, sheetName.substring(0, 31));
            });
            
            XLSX.writeFile(workbook, `CMC_Weekly_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            document.getElementById('export-menu').classList.remove('show');
        }

        function exportMonthlyReport() {
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            const allData = JSON.parse(localStorage.getItem('cmc_feedback') || '[]');
            const monthData = allData.filter(sub => {
                const subDate = new Date(sub.datetime);
                return subDate >= monthStart && subDate <= monthEnd;
            });
            
            const workbook = XLSX.utils.book_new();
            
            // Group by date
            const byDate = {};
            monthData.forEach(sub => {
                if (!byDate[sub.date_readable]) byDate[sub.date_readable] = [];
                byDate[sub.date_readable].push(sub);
            });
            
            const dates = Object.keys(byDate).sort();
            let dayCount = 0;
            
            dates.forEach(dateKey => {
                dayCount++;
                const records = [];
                const meals = ['Breakfast', 'Lunch', 'Dinner'];
                
                meals.forEach(mealType => {
                    const mealData = byDate[dateKey].filter(d => d.meal_type === mealType);
                    if (mealData.length > 0) {
                        records.push({ // Meal header
                            'Date': dateKey,
                            'Meal Type': mealType,
                            'Student Name': '',
                            'Roll Number': '',
                            'Items Reviewed': '',
                            'Avg Taste': '',
                            'Avg Quality': '',
                            'Avg Quantity': '',
                            'Avg Cleanliness': '',
                            'Overall Rating': ''
                        });
                        
                        mealData.forEach(sub => {
                            const itemCount = sub.items.length;
                            const totals = sub.items.reduce((acc, item) => ({
                                taste: acc.taste + item.taste,
                                quality: acc.quality + item.quality,
                                quantity: acc.quantity + item.quantity,
                                cleanliness: acc.cleanliness + item.cleanliness
                            }), {taste: 0, quality: 0, quantity: 0, cleanliness: 0});
                            
                            records.push({
                                'Date': dateKey,
                                'Meal Type': mealType,
                                'Student Name': sub.student_name,
                                'Roll Number': sub.student_roll,
                                'Items Reviewed': sub.items.map(i => i.item_name).join(', '),
                                'Avg Taste': (totals.taste / itemCount).toFixed(2),
                                'Avg Quality': (totals.quality / itemCount).toFixed(2),
                                'Avg Quantity': (totals.quantity / itemCount).toFixed(2),
                                'Avg Cleanliness': (totals.cleanliness / itemCount).toFixed(2),
                                'Overall Rating': ((totals.taste + totals.quality + totals.quantity + totals.cleanliness) / (itemCount * 4)).toFixed(2)
                            });
                        });
                    }
                });
                
                const ws = XLSX.utils.json_to_sheet(records);
                const dayName = new Date(dateKey).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const sheetName = `Day ${dayCount} (${dayName})`;
                XLSX.utils.book_append_sheet(workbook, ws, sheetName.substring(0, 31));
            });
            
            XLSX.writeFile(workbook, `CMC_Monthly_Report_${now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}.xlsx`);
            document.getElementById('export-menu').classList.remove('show');
        }

        updateDashboard();
    </script>
</body>
</html>