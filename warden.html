<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warden Dashboard - CMC Mess Management</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .user-info {
            text-align: right;
            font-size: 0.9rem;
        }
        
        .user-info .name {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: white;
            color: #667eea;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .welcome-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .welcome-section h2 {
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .welcome-section p {
            color: #666;
            font-size: 0.95rem;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border-top: 5px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }
        
        .feature-card.active {
            border-top-color: #ffcc00;
            background: #f8f9ff;
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .feature-card h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #333;
        }
        
        .feature-card p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .btn-action {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .content-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .content-header h2 {
            color: #333;
            font-size: 1.6rem;
        }
        
        .close-btn {
            background: #f0f0f0;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: #e0e0e0;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .feedback-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .feedback-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .feedback-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .feedback-table tr:hover {
            background: #f9f9f9;
        }
        
        .editable-cell {
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .editable-cell:hover {
            background: #fff3cd;
            font-weight: 600;
        }
        
        .btn-edit, .btn-delete {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #667eea;
            color: white;
        }
        
        .btn-edit:hover {
            background: #5568d3;
            transform: scale(1.1);
        }
        
        .btn-delete {
            background: #ff6b6b;
            color: white;
        }
        
        .btn-delete:hover {
            background: #ee5a5a;
            transform: scale(1.1);
        }
        
        .rating-badge {
            background: #ffcc00;
            color: #333;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-msg {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
            margin-bottom: 20px;
            display: none;
        }
        
        .date-range {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-box .label {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .stat-box .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }
        
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            header h1 {
                font-size: 1.4rem;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <h1>üë®‚Äçüíº Warden Dashboard</h1>
        <div class="header-info">
            <div class="user-info">
                <div class="name" id="user-name">Loading...</div>
                <small>Authorized Warden</small>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </header>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h2>Welcome Back, <span id="user-greeting">Warden</span>!</h2>
            <p>Manage daily food counts, monitor student feedback, and maintain food quality standards.</p>
        </div>
        
        <!-- Features Grid -->
        <div class="features-grid">
            <div class="feature-card" onclick="showContent('add-count')">
                <div class="feature-icon">üìÖ</div>
                <h3>Add Next-Day Food Count</h3>
                <p>Enter daily food counts for breakfast, lunch, and dinner for students and faculty.</p>
                <button class="btn-action">Get Started</button>
            </div>

            <div class="feature-card" onclick="showContent('view-count-report')">
                <div class="feature-icon">üìà</div>
                <h3>View Food Count Reports</h3>
                <p>View and analyze daily food counts by day, week, month or custom range. Export as CSV.</p>
                <button class="btn-action">View Reports</button>
            </div>
            
            <div class="feature-card" onclick="showContent('view-feedback')">
                <div class="feature-icon">üìä</div>
                <h3>View Student Feedback</h3>
                <p>Review daily or date-wise feedback with ratings and complaints from students.</p>
                <button class="btn-action">View Feedback</button>
            </div>
            
            <div class="feature-card" onclick="showContent('impose-fine')">
                <div class="feature-icon">‚öñÔ∏è</div>
                <h3>Impose Fines</h3>
                <p>Apply fines to vendors for quality deviations and service issues.</p>
                <button class="btn-action">Add Fine</button>
            </div>
        </div>
        
        <!-- Content Sections -->
        
        <!-- Add Food Count Section -->
        <div id="add-count" class="content-section">
            <div class="content-header">
                <h2>üìÖ Add Next-Day Food Count</h2>
                <button class="close-btn" onclick="closeContent()">‚Üê Back to Dashboard</button>
            </div>
            
            <div class="form-section">
                <h3>Select Date for Food Count</h3>
                <div class="form-group">
                    <label for="count-date">Date</label>
                    <input type="date" id="count-date" required>
                </div>
            </div>
            
            <div id="success-msg-count" class="success-msg"></div>
            
            <div class="form-section">
                <h3>Students Count</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="student-breakfast">Breakfast</label>
                        <input type="number" id="student-breakfast" min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="student-lunch">Lunch</label>
                        <input type="number" id="student-lunch" min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="student-dinner">Dinner</label>
                        <input type="number" id="student-dinner" min="0" placeholder="0">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Faculty/Teachers Count</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="faculty-breakfast">Breakfast</label>
                        <input type="number" id="faculty-breakfast" min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="faculty-lunch">Lunch</label>
                        <input type="number" id="faculty-lunch" min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="faculty-dinner">Dinner</label>
                        <input type="number" id="faculty-dinner" min="0" placeholder="0">
                    </div>
                </div>
            </div>
            
            <button class="btn-submit" onclick="saveFoodCount()">Save Food Count</button>
            
            <div class="form-section" style="margin-top: 30px;">
                <h3>Recent Food Counts</h3>
                <table class="feedback-table" id="count-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Students Count (Click to edit)</th>
                            <th>Faculty Count (Click to edit)</th>
                            <th>Total People</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="count-body">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999;">No food counts added yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- View Food Count Report Section -->
        <div id="view-count-report" class="content-section">
            <div class="content-header">
                <h2>üìà Food Count Reports</h2>
                <button class="close-btn" onclick="closeContent()">‚Üê Back to Dashboard</button>
            </div>

            <div class="date-range">
                <div class="form-group">
                    <label for="count-report-mode">Report Type</label>
                    <select id="count-report-mode" onchange="onCountReportModeChange()">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>

                <div class="form-group" id="count-control-date">
                    <label for="count-report-date">Select Date</label>
                    <input type="date" id="count-report-date">
                </div>

                <div class="form-group" id="count-control-week" style="display:none;">
                    <label for="count-report-week-date">Week Date</label>
                    <input type="date" id="count-report-week-date">
                </div>

                <div class="form-group" id="count-control-month" style="display:none;">
                    <label for="count-report-month">Select Month</label>
                    <input type="month" id="count-report-month">
                </div>

                <div class="form-group" id="count-control-custom" style="display:none;">
                    <label>Custom Range</label>
                    <div style="display:flex; gap:8px;">
                        <input type="date" id="count-report-start">
                        <input type="date" id="count-report-end">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <button class="btn-action" onclick="generateCountReport()">Search</button>
                    <button class="btn-secondary" onclick="exportCountCSV()">Export CSV</button>
                </div>
            </div>

            <div class="stats-row" id="count-report-stats"></div>

            <table class="feedback-table" id="count-report-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Meal Type</th>
                        <th>Student Count</th>
                        <th>Faculty Count</th>
                        <th>Total People</th>
                    </tr>
                </thead>
                <tbody id="count-report-body">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #999;">Select date range to view food counts</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- View Feedback Section -->
        <div id="view-feedback" class="content-section">
            <div class="content-header">
                <h2>üìä View Student Feedback</h2>
                <button class="close-btn" onclick="closeContent()">‚Üê Back to Dashboard</button>
            </div>
            
            <div class="date-range">
                <div class="form-group">
                    <label for="report-mode">Report Type</label>
                    <select id="report-mode" onchange="onReportModeChange()">
                        <option value="daily">Daily (Select Date)</option>
                        <option value="weekly">Weekly (Select Week Date)</option>
                        <option value="monthly">Monthly (Select Month)</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>

                <div class="form-group" id="control-date">
                    <label for="feedback-date">Select Date</label>
                    <input type="date" id="feedback-date">
                </div>

                <div class="form-group" id="control-week" style="display:none;">
                    <label for="feedback-week-date">Week Date</label>
                    <input type="date" id="feedback-week-date">
                </div>

                <div class="form-group" id="control-month" style="display:none;">
                    <label for="feedback-month">Select Month</label>
                    <input type="month" id="feedback-month">
                </div>

                <div class="form-group" id="control-custom" style="display:none;">
                    <label>Custom Range</label>
                    <div style="display:flex; gap:8px;">
                        <input type="date" id="report-start">
                        <input type="date" id="report-end">
                    </div>
                </div>

                <div class="form-group">
                    <label for="feedback-meal">Meal Type</label>
                    <select id="feedback-meal">
                        <option value="">All Meals</option>
                        <option value="breakfast">Breakfast</option>
                        <option value="lunch">Lunch</option>
                        <option value="dinner">Dinner</option>
                    </select>
                </div>

                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <button class="btn-action" onclick="generateFeedbackReport()">Search</button>
                    <button class="btn-secondary" onclick="exportFeedbackCSV()">Export CSV</button>
                </div>
            </div>
            
            <div class="stats-row" id="feedback-stats"></div>
            
            <table class="feedback-table" id="feedback-table">
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Roll No</th>
                        <th>Date</th>
                        <th>Meal</th>
                        <th>Overall Rating</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody id="feedback-body">
                    <tr>
                        <td colspan="6" style="text-align: center; color: #999;">No feedback available</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Impose Fine Section -->
        <div id="impose-fine" class="content-section">
            <div class="content-header">
                <h2>‚öñÔ∏è Impose Fine on Vendor</h2>
                <button class="close-btn" onclick="closeContent()">‚Üê Back to Dashboard</button>
            </div>
            
            <div id="success-msg-fine" class="success-msg"></div>
            
            <div class="form-section">
                <h3>Fine Details</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="fine-date">Date of Issue</label>
                        <input type="date" id="fine-date" required>
                    </div>
                    <div class="form-group">
                        <label for="fine-vendor">Select Mess/Vendor</label>
                        <select id="fine-vendor" required>
                            <option value="">-- Select Vendor --</option>
                            <option value="mess-001">Mess A (North Block)</option>
                            <option value="mess-002">Mess B (South Block)</option>
                            <option value="mess-003">Mess C (East Block)</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="fine-reason">Reason for Fine</label>
                    <select id="fine-reason" required>
                        <option value="">-- Select Reason --</option>
                        <option value="poor-quality">Poor Quality Food</option>
                        <option value="hygiene-issue">Hygiene Issue</option>
                        <option value="late-service">Late Service</option>
                        <option value="wrong-item">Wrong Item Served</option>
                        <option value="expired-food">Expired/Spoiled Food</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="fine-amount">Fine Amount (‚Çπ)</label>
                        <input type="number" id="fine-amount" min="0" step="100" placeholder="0" required>
                    </div>
                    <div class="form-group">
                        <label for="fine-meal">Meal Affected</label>
                        <select id="fine-meal" required>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="fine-remarks">Remarks/Details</label>
                    <textarea id="fine-remarks" rows="4" placeholder="Describe the issue in detail..."></textarea>
                </div>
            </div>
            
            <button class="btn-submit" onclick="imposeFine()">Impose Fine</button>
            
            <div class="form-section" style="margin-top: 30px;">
                <h3>Recent Fines Imposed</h3>
                <table class="feedback-table" id="fines-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Vendor/Mess</th>
                            <th>Reason</th>
                            <th>Amount (‚Çπ)</th>
                            <th>Meal</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="fines-body">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #999;">No fines imposed yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize warden dashboard
        let userData = null;
        
        window.addEventListener('load', () => {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user || user.role !== 'warden') {
                window.location.href = 'login.html';
                return;
            }
            
            userData = user;
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-greeting').textContent = user.username;
            
            // Set today's date for food count with restrictions
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            document.getElementById('count-date').valueAsDate = today;
            document.getElementById('count-date').min = todayString; // Prevent selecting past dates
            document.getElementById('feedback-date').valueAsDate = today;
            document.getElementById('fine-date').valueAsDate = today;
            
            // Load initial data
            loadFoodCounts();
            loadFeedback();
            loadFines();
        });
        
        function showContent(section) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function closeContent() {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
        }
        
        function saveFoodCount() {
            const date = document.getElementById('count-date').value;
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            const foodCount = {
                date: date,
                students: {
                    breakfast: parseInt(document.getElementById('student-breakfast').value) || 0,
                    lunch: parseInt(document.getElementById('student-lunch').value) || 0,
                    dinner: parseInt(document.getElementById('student-dinner').value) || 0
                },
                faculty: {
                    breakfast: parseInt(document.getElementById('faculty-breakfast').value) || 0,
                    lunch: parseInt(document.getElementById('faculty-lunch').value) || 0,
                    dinner: parseInt(document.getElementById('faculty-dinner').value) || 0
                },
                timestamp: new Date().toISOString()
            };
            
            let counts = JSON.parse(localStorage.getItem('foodCounts') || '[]');
            counts = counts.filter(c => c.date !== date);
            counts.unshift(foodCount);
            localStorage.setItem('foodCounts', JSON.stringify(counts));
            
            const msg = document.getElementById('success-msg-count');
            msg.textContent = '‚úì Food count saved successfully!';
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
            
            loadFoodCounts();
        }
        
        function loadFoodCounts() {
            const counts = JSON.parse(localStorage.getItem('foodCounts') || '[]');
            const tbody = document.getElementById('count-body');
            
            if (counts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No food counts added yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = counts.slice(0, 10).map((count, index) => {
                const studentTotal = count.students.breakfast + count.students.lunch + count.students.dinner;
                const facultyTotal = count.faculty.breakfast + count.faculty.lunch + count.faculty.dinner;
                return `
                    <tr id="count-row-${index}">
                        <td>${new Date(count.date).toLocaleDateString('en-IN')}</td>
                        <td class="editable-cell" onclick="makeEditable(${index}, 'student')" title="Click to edit"><span id="student-display-${index}">${studentTotal}</span></td>
                        <td class="editable-cell" onclick="makeEditable(${index}, 'faculty')" title="Click to edit"><span id="faculty-display-${index}">${facultyTotal}</span></td>
                        <td>${studentTotal + facultyTotal}</td>
                        <td style="display: flex; gap: 5px;">
                            <button class="btn-edit" onclick="editCount(${index})" title="Edit">‚úèÔ∏è</button>
                            <button class="btn-delete" onclick="deleteCount(${index})" title="Delete">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function makeEditable(index, type) {
            const counts = JSON.parse(localStorage.getItem('foodCounts') || '[]');
            const count = counts[index];
            
            if (type === 'student') {
                const newValue = prompt('Enter total student count (or individual counts separated by commas for B,L,D):', 
                    `${count.students.breakfast},${count.students.lunch},${count.students.dinner}`);
                if (newValue) {
                    const parts = newValue.split(',').map(v => parseInt(v.trim()) || 0);
                    if (parts.length === 3) {
                        count.students.breakfast = parts[0];
                        count.students.lunch = parts[1];
                        count.students.dinner = parts[2];
                    } else {
                        alert('Please enter 3 numbers separated by commas (Breakfast, Lunch, Dinner)');
                        return;
                    }
                }
            } else if (type === 'faculty') {
                const newValue = prompt('Enter total faculty count (or individual counts separated by commas for B,L,D):', 
                    `${count.faculty.breakfast},${count.faculty.lunch},${count.faculty.dinner}`);
                if (newValue) {
                    const parts = newValue.split(',').map(v => parseInt(v.trim()) || 0);
                    if (parts.length === 3) {
                        count.faculty.breakfast = parts[0];
                        count.faculty.lunch = parts[1];
                        count.faculty.dinner = parts[2];
                    } else {
                        alert('Please enter 3 numbers separated by commas (Breakfast, Lunch, Dinner)');
                        return;
                    }
                }
            }
            
            counts[index] = count;
            localStorage.setItem('foodCounts', JSON.stringify(counts));
            loadFoodCounts();
        }
        
        function editCount(index) {
            const counts = JSON.parse(localStorage.getItem('foodCounts') || '[]');
            const count = counts[index];
            
            const editHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;" id="edit-modal-${index}">
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
                        <h3>Edit Food Count - ${new Date(count.date).toLocaleDateString('en-IN')}</h3>
                        <div style="margin-top: 20px;">
                            <h4>Students</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                                <div>
                                    <label>Breakfast</label>
                                    <input type="number" id="edit-sb-${index}" value="${count.students.breakfast}" min="0">
                                </div>
                                <div>
                                    <label>Lunch</label>
                                    <input type="number" id="edit-sl-${index}" value="${count.students.lunch}" min="0">
                                </div>
                                <div>
                                    <label>Dinner</label>
                                    <input type="number" id="edit-sd-${index}" value="${count.students.dinner}" min="0">
                                </div>
                            </div>
                            <h4>Faculty</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                                <div>
                                    <label>Breakfast</label>
                                    <input type="number" id="edit-fb-${index}" value="${count.faculty.breakfast}" min="0">
                                </div>
                                <div>
                                    <label>Lunch</label>
                                    <input type="number" id="edit-fl-${index}" value="${count.faculty.lunch}" min="0">
                                </div>
                                <div>
                                    <label>Dinner</label>
                                    <input type="number" id="edit-fd-${index}" value="${count.faculty.dinner}" min="0">
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeEditModal(${index})" style="padding: 8px 16px; background: #ccc; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                            <button onclick="saveEditedCount(${index})" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', editHTML);
        }
        
        function closeEditModal(index) {
            const modal = document.getElementById(`edit-modal-${index}`);
            if (modal) modal.remove();
        }
        
        function saveEditedCount(index) {
            const counts = JSON.parse(localStorage.getItem('foodCounts') || '[]');
            counts[index].students.breakfast = parseInt(document.getElementById(`edit-sb-${index}`).value) || 0;
            counts[index].students.lunch = parseInt(document.getElementById(`edit-sl-${index}`).value) || 0;
            counts[index].students.dinner = parseInt(document.getElementById(`edit-sd-${index}`).value) || 0;
            counts[index].faculty.breakfast = parseInt(document.getElementById(`edit-fb-${index}`).value) || 0;
            counts[index].faculty.lunch = parseInt(document.getElementById(`edit-fl-${index}`).value) || 0;
            counts[index].faculty.dinner = parseInt(document.getElementById(`edit-fd-${index}`).value) || 0;
            
            localStorage.setItem('foodCounts', JSON.stringify(counts));
            closeEditModal(index);
            loadFoodCounts();
        }
        
        function deleteCount(index) {
            if (confirm('Are you sure you want to delete this food count record?')) {
                let counts = JSON.parse(localStorage.getItem('foodCounts') || '[]');
                counts.splice(index, 1);
                localStorage.setItem('foodCounts', JSON.stringify(counts));
                loadFoodCounts();
            }
        }
        
        function filterFeedback() {
            loadFeedback();
        }
        
        function loadFeedback() {
            const feedbacks = JSON.parse(localStorage.getItem('feedbackData') || '[]');
            const selectedMeal = document.getElementById('feedback-meal').value;
            let filtered = feedbacks;
            // If generateFeedbackReport created a filtered array, use it
            if (window.__filteredFeedback) {
                filtered = window.__filteredFeedback;
            }
            // If meal filter applied on top
            if (selectedMeal) {
                filtered = filtered.filter(f => f.mealType === selectedMeal);
            }
            
            const tbody = document.getElementById('feedback-body');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No feedback available</td></tr>';
                document.getElementById('feedback-stats').innerHTML = '';
                return;
            }
            
            // Calculate stats
            const avgRating = (filtered.reduce((sum, f) => sum + f.overallRating, 0) / filtered.length).toFixed(1);
            const stats = `
                <div class="stat-box">
                    <div class="label">Total Feedbacks</div>
                    <div class="value">${filtered.length}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Average Rating</div>
                    <div class="value">${avgRating}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Avg. Taste</div>
                    <div class="value">${(filtered.reduce((sum, f) => sum + (f.ratings?.taste || 0), 0) / filtered.length).toFixed(1)}</div>
                </div>
            `;
            document.getElementById('feedback-stats').innerHTML = stats;
            
            tbody.innerHTML = filtered.map(f => `
                <tr>
                    <td>${f.studentName}</td>
                    <td>${f.rollNumber}</td>
                    <td>${new Date(f.date).toLocaleDateString('en-IN')}</td>
                    <td style="text-transform: capitalize;">${f.mealType}</td>
                    <td><span class="rating-badge">${f.overallRating}/5</span></td>
                    <td>${f.comments || '-'}</td>
                </tr>
            `).join('');
        }

        function onReportModeChange() {
            const mode = document.getElementById('report-mode').value;
            document.getElementById('control-date').style.display = mode === 'daily' ? '' : 'none';
            document.getElementById('control-week').style.display = mode === 'weekly' ? '' : 'none';
            document.getElementById('control-month').style.display = mode === 'monthly' ? '' : 'none';
            document.getElementById('control-custom').style.display = mode === 'custom' ? '' : 'none';
        }

        async function generateFeedbackReport() {
            const mode = document.getElementById('report-mode').value;
            let start = null, end = null;
            if (mode === 'daily') {
                const d = document.getElementById('feedback-date').value;
                if (!d) { alert('Select a date'); return; }
                start = end = d;
            } else if (mode === 'weekly') {
                const d = document.getElementById('feedback-week-date').value;
                if (!d) { alert('Select a week date'); return; }
                const dt = new Date(d);
                const day = dt.getDay();
                const diffToMonday = (day + 6) % 7;
                const monday = new Date(dt);
                monday.setDate(dt.getDate() - diffToMonday);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                start = monday.toISOString().slice(0,10);
                end = sunday.toISOString().slice(0,10);
            } else if (mode === 'monthly') {
                const m = document.getElementById('feedback-month').value; // YYYY-MM
                if (!m) { alert('Select a month'); return; }
                start = m + '-01';
                const [yy, mm] = m.split('-').map(x => parseInt(x,10));
                const lastDay = new Date(yy, mm, 0).getDate();
                end = `${m}-${String(lastDay).padStart(2,'0')}`;
            } else if (mode === 'custom') {
                const s = document.getElementById('report-start').value;
                const e = document.getElementById('report-end').value;
                if (!s || !e) { alert('Select start and end date'); return; }
                if (s > e) { alert('Start date must be <= end date'); return; }
                start = s; end = e;
            }

            const meal = document.getElementById('feedback-meal').value || '';

            // Try server API first
            try {
                const url = `/api/feedback?start=${start}&end=${end}` + (meal ? `&meal=${meal}` : '');
                const resp = await fetch(url);
                if (resp.ok) {
                    const data = await resp.json();
                    window.__filteredFeedback = data;
                    loadFeedback();
                    return;
                }
            } catch (e) {
                console.warn('API fetch failed, falling back to local data', e);
            }

            // Fallback: compute from localStorage
            const data = JSON.parse(localStorage.getItem('feedbackData') || '[]');
            let filtered = data.filter(f => f.date >= start && f.date <= end);
            if (meal) filtered = filtered.filter(f => f.mealType === meal);
            window.__filteredFeedback = filtered;
            loadFeedback();
        }

        function exportFeedbackCSV() {
            const arr = (window.__filteredFeedback && window.__filteredFeedback.length) ? window.__filteredFeedback : JSON.parse(localStorage.getItem('feedbackData') || '[]');
            if (!arr || arr.length === 0) { alert('No data to export'); return; }
            const headers = ['studentName','rollNumber','date','mealType','overallRating','taste','quality','comments'];
            const csv = [headers.join(',')].concat(arr.map(r => headers.map(h => {
                let v = r[h] === undefined ? '' : r[h];
                if (typeof v === 'string') v = v.replace(/"/g, '""');
                return '"' + String(v) + '"';
            }).join(','))).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `feedback_report_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }
        
        function imposeFine() {
            const date = document.getElementById('fine-date').value;
            const vendor = document.getElementById('fine-vendor').value;
            const reason = document.getElementById('fine-reason').value;
            const amount = document.getElementById('fine-amount').value;
            const meal = document.getElementById('fine-meal').value;
            const remarks = document.getElementById('fine-remarks').value;
            
            if (!date || !vendor || !reason || !amount) {
                alert('Please fill all required fields');
                return;
            }
            
            const fine = {
                id: Date.now().toString(),
                date: date,
                vendor: vendor,
                reason: reason,
                amount: parseInt(amount),
                meal: meal,
                remarks: remarks,
                imposedBy: userData.username,
                timestamp: new Date().toISOString(),
                status: 'Imposed'
            };
            
            let fines = JSON.parse(localStorage.getItem('fines') || '[]');
            fines.unshift(fine);
            localStorage.setItem('fines', JSON.stringify(fines));
            
            const msg = document.getElementById('success-msg-fine');
            msg.textContent = '‚úì Fine imposed successfully!';
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);
            
            // Clear form
            document.getElementById('fine-vendor').value = '';
            document.getElementById('fine-reason').value = '';
            document.getElementById('fine-amount').value = '';
            document.getElementById('fine-remarks').value = '';
            
            loadFines();
        }
        
        function loadFines() {
            const fines = JSON.parse(localStorage.getItem('fines') || '[]');
            const tbody = document.getElementById('fines-body');
            
            if (fines.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No fines imposed yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = fines.slice(0, 10).map(fine => {
                const messName = {
                    'mess-001': 'Mess A',
                    'mess-002': 'Mess B',
                    'mess-003': 'Mess C'
                }[fine.vendor] || fine.vendor;
                
                return `
                    <tr>
                        <td>${new Date(fine.date).toLocaleDateString('en-IN')}</td>
                        <td>${messName}</td>
                        <td>${fine.reason.replace('-', ' ')}</td>
                        <td>‚Çπ${fine.amount}</td>
                        <td style="text-transform: capitalize;">${fine.meal}</td>
                        <td><span class="rating-badge" style="background: #ff6b6b; color: white;">${fine.status}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // ===== FOOD COUNT REPORT FUNCTIONS =====
        function onCountReportModeChange() {
            const mode = document.getElementById('count-report-mode').value;
            document.getElementById('count-control-date').style.display = mode === 'daily' ? '' : 'none';
            document.getElementById('count-control-week').style.display = mode === 'weekly' ? '' : 'none';
            document.getElementById('count-control-month').style.display = mode === 'monthly' ? '' : 'none';
            document.getElementById('count-control-custom').style.display = mode === 'custom' ? '' : 'none';
        }

        async function generateCountReport() {
            const mode = document.getElementById('count-report-mode').value;
            let start = null, end = null;
            if (mode === 'daily') {
                const d = document.getElementById('count-report-date').value;
                if (!d) { alert('Select a date'); return; }
                start = end = d;
            } else if (mode === 'weekly') {
                const d = document.getElementById('count-report-week-date').value;
                if (!d) { alert('Select a week date'); return; }
                const dt = new Date(d);
                const day = dt.getDay();
                const diffToMonday = (day + 6) % 7;
                const monday = new Date(dt);
                monday.setDate(dt.getDate() - diffToMonday);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                start = monday.toISOString().slice(0,10);
                end = sunday.toISOString().slice(0,10);
            } else if (mode === 'monthly') {
                const m = document.getElementById('count-report-month').value; // YYYY-MM
                if (!m) { alert('Select a month'); return; }
                start = m + '-01';
                const [yy, mm] = m.split('-').map(x => parseInt(x,10));
                const lastDay = new Date(yy, mm, 0).getDate();
                end = `${m}-${String(lastDay).padStart(2,'0')}`;
            } else if (mode === 'custom') {
                const s = document.getElementById('count-report-start').value;
                const e = document.getElementById('count-report-end').value;
                if (!s || !e) { alert('Select start and end date'); return; }
                if (s > e) { alert('Start date must be <= end date'); return; }
                start = s; end = e;
            }

            // Try server API first
            try {
                const url = `/api/food-counts?start=${start}&end=${end}`;
                const resp = await fetch(url);
                if (resp.ok) {
                    const data = await resp.json();
                    window.__filteredCountData = data;
                    renderCountReport(data);
                    return;
                }
            } catch (e) {
                console.warn('API fetch failed, falling back to localStorage', e);
            }

            // Fallback to localStorage
            window.__filteredCountData = [];
            renderCountReport([]);
        }

        function renderCountReport(data) {
            if (!data || data.length === 0) {
                document.getElementById('count-report-body').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No food count data available</td></tr>';
                document.getElementById('count-report-stats').innerHTML = '';
                return;
            }

            // Calculate stats
            let totalStudents = 0, totalFaculty = 0, totalPeople = 0;
            data.forEach(r => {
                totalStudents += r.studentCount || 0;
                totalFaculty += r.facultyCount || 0;
                totalPeople += (r.studentCount || 0) + (r.facultyCount || 0);
            });

            const avgStudents = (totalStudents / data.length).toFixed(0);
            const avgFaculty = (totalFaculty / data.length).toFixed(0);
            const avgTotal = (totalPeople / data.length).toFixed(0);

            const stats = `
                <div class="stat-box">
                    <div class="label">Total Records</div>
                    <div class="value">${data.length}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Total Students Fed</div>
                    <div class="value">${totalStudents}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Total Faculty Fed</div>
                    <div class="value">${totalFaculty}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Avg Daily People</div>
                    <div class="value">${avgTotal}</div>
                </div>
            `;
            document.getElementById('count-report-stats').innerHTML = stats;

            document.getElementById('count-report-body').innerHTML = data.map(r => `
                <tr>
                    <td>${new Date(r.date).toLocaleDateString('en-IN')}</td>
                    <td style="text-transform: capitalize;">${r.mealType}</td>
                    <td>${r.studentCount}</td>
                    <td>${r.facultyCount}</td>
                    <td><strong>${(r.studentCount || 0) + (r.facultyCount || 0)}</strong></td>
                </tr>
            `).join('');
        }

        function exportCountCSV() {
            const arr = window.__filteredCountData;
            if (!arr || arr.length === 0) { alert('No data to export'); return; }
            const headers = ['date','mealType','studentCount','facultyCount','totalPeople'];
            const csv = [headers.join(',')].concat(arr.map(r => headers.map(h => {
                let v = r[h];
                if (h === 'totalPeople') v = (r.studentCount || 0) + (r.facultyCount || 0);
                if (v === undefined) v = '';
                if (typeof v === 'string') v = v.replace(/"/g, '""');
                return '"' + String(v) + '"';
            }).join(','))).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `food_count_report_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
