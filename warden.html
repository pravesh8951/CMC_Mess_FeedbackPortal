<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warden Dashboard - CMC Mess Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <style>
        /* ... (Your existing CSS here, no changes needed) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .user-info {
            text-align: right;
            font-size: 0.9rem;
        }
        
        .user-info .name {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-logout:hover {
            background: white;
            color: #667eea;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .welcome-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        
        .welcome-section h2 {
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .welcome-section p {
            color: #666;
            font-size: 0.95rem;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .feature-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            border-top: 5px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
        }
        
        .feature-card.active {
            border-top-color: #ffcc00;
            background: #f8f9ff;
        }
        
        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .feature-card h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #333;
        }
        
        .feature-card p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .btn-action {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .content-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .content-header h2 {
            color: #333;
            font-size: 1.6rem;
        }
        
        .close-btn {
            background: #f0f0f0;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: #e0e0e0;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .feedback-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .feedback-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .feedback-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .feedback-table tr:hover {
            background: #f9f9f9;
        }
        
        .editable-cell {
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .editable-cell:hover {
            background: #fff3cd;
            font-weight: 600;
        }
        
        .btn-edit, .btn-delete {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background: #667eea;
            color: white;
        }
        
        .btn-edit:hover {
            background: #5568d3;
            transform: scale(1.1);
        }
        
        .btn-delete {
            background: #ff6b6b;
            color: white;
        }
        
        .btn-delete:hover {
            background: #ee5a5a;
            transform: scale(1.1);
        }
        
        .rating-badge {
            background: #ffcc00;
            color: #333;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #28a745;
            margin-bottom: 20px;
            display: none;
        }
        
        .error-msg {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #dc3545;
            margin-bottom: 20px;
            display: none;
        }
        
        .date-range {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-box .label {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .stat-box .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-wrapper {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .chart-wrapper h4 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 1.1rem;
        }

        .chart-wrapper canvas {
            max-height: 300px;
        }
        
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            header h1 {
                font-size: 1.4rem;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }

            .chart-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <h1>üë®‚Äçüíº Warden Dashboard</h1>
        <div class="header-info">
            <div class="user-info">
                <div class="name" id="user-name">Loading...</div>
                <small>Authorized Warden</small>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </header>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Welcome Section -->
        <div class="welcome-section">
            <h2>Welcome Back, <span id="user-greeting">Warden</span>!</h2>
            <p>Manage daily food counts, monitor student feedback, and maintain food quality standards.</p>
        </div>
        
        <!-- Features Grid -->
        <div class="features-grid">
            <div class="feature-card" onclick="showContent('add-count')">
                <div class="feature-icon">üìÖ</div>
                <h3>Add Next-Day Food Count</h3>
                <p>Enter daily food counts for breakfast, lunch, and dinner for students and faculty.</p>
                <button class="btn-action">Get Started</button>
            </div>

            <div class="feature-card" onclick="showContent('view-count-report')">
                <div class="feature-icon">üìà</div>
                <h3>View Food Count Reports</h3>
                <p>View and analyze daily food counts by day, week, month or custom range. Export as CSV.</p>
                <button class="btn-action">View Reports</button>
            </div>
            
            <div class="feature-card" onclick="showContent('view-feedback')">
                <div class="feature-icon">üìä</div>
                <h3>View Student Feedback</h3>
                <p>Review daily or date-wise feedback with ratings and complaints from students.</p>
                <button class="btn-action">View Feedback</button>
            </div>
            
            <div class="feature-card" onclick="showContent('impose-fine')">
                <div class="feature-icon">‚öñÔ∏è</div>
                <h3>Impose Fines</h3>
                <p>Apply fines to vendors for quality deviations and service issues.</p>
                <button class="btn-action">Add Fine</button>
            </div>
        </div>
        
        <!-- Content Sections -->
        
        <!-- Add Food Count Section -->
        <div id="add-count" class="content-section">
            <div class="content-header">
                <h2>üìÖ Add Next-Day Food Count</h2>
                <button class="close-btn" onclick="closeContent()">‚Üê Back to Dashboard</button>
            </div>
            
            <div class="form-section">
                <h3>Select Date for Food Count</h3>
                <div class="form-group">
                    <label for="count-date">Date</label>
                    <input type="date" id="count-date" required>
                </div>
            </div>
            
            <div id="success-msg-count" class="success-msg"></div>
            
            <div class="form-section">
                <h3>Students Count</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="student-breakfast">Breakfast</label>
                        <input type="number" id="student-breakfast" min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="student-lunch">Lunch</label>
                        <input type="number" id="student-lunch" min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="student-dinner">Dinner</label>
                        <input type="number" id="student-dinner" min="0" placeholder="0">
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Faculty/Teachers Count</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="faculty-breakfast">Breakfast</label>
                        <input type="number" id="faculty-breakfast" min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="faculty-lunch">Lunch</label>
                        <input type="number" id="faculty-lunch" min="0" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="faculty-dinner">Dinner</label>
                        <input type="number" id="faculty-dinner" min="0" placeholder="0">
                    </div>
                </div>
            </div>
            
            <button class="btn-submit" onclick="saveFoodCount()">Save Food Count</button>
            
            <div class="form-section" style="margin-top: 30px;">
                <h3>Recent Food Counts</h3>
                <table class="feedback-table" id="count-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Breakfast</th>
                            <th>Lunch</th>
                            <th>Dinner</th>
                            <th>Maximum People Fed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="count-body">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #999;">No food counts added yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- View Food Count Report Section -->
        <div id="view-count-report" class="content-section">
            <div class="content-header">
                <h2>üìà Food Count Reports</h2>
                <button class="close-btn" onclick="closeContent()">‚Üê Back to Dashboard</button>
            </div>

            <div class="date-range">
                <div class="form-group">
                    <label for="count-report-mode">Report Type</label>
                    <select id="count-report-mode" onchange="onCountReportModeChange()">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>

                <div class="form-group" id="count-control-date">
                    <label for="count-report-date">Select Date</label>
                    <input type="date" id="count-report-date">
                </div>

                <div class="form-group" id="count-control-week" style="display:none;">
                    <label for="count-report-week-date">Week Date</label>
                    <input type="date" id="count-report-week-date">
                </div>

                <div class="form-group" id="count-control-month" style="display:none;">
                    <label for="count-report-month">Select Month</label>
                    <input type="month" id="count-report-month">
                </div>

                <div class="form-group" id="count-control-custom" style="display:none;">
                    <label>Custom Range</label>
                    <div style="display:flex; gap:8px;">
                        <input type="date" id="count-report-start">
                        <input type="date" id="count-report-end">
                    </div>
                </div>

                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <button class="btn-action" onclick="generateCountReport()">Search</button>
                    <button class="btn-secondary" onclick="exportCountCSV()">Export CSV</button>
                    <button class="btn-secondary" onclick="exportCountPDF()">Generate PDF</button>
                </div>
            </div>

            <div class="stats-row" id="count-report-stats"></div>

            <table class="feedback-table" id="count-report-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Breakfast</th>
                        <th>Lunch</th>
                        <th>Dinner</th>
                        <th>Maximum People Fed</th>
                    </tr>
                </thead>
                <tbody id="count-report-body">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #999;">Select date range to view food counts</td>
                    </tr>
                </tbody>
            </table>

            <div class="chart-row" id="count-charts-container" style="display:none;">
                <div class="chart-wrapper">
                    <h4>Daily Food Count Distribution</h4>
                    <canvas id="countBarChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <h4>Meal-wise Average Count</h4>
                    <canvas id="countPieChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- View Feedback Section -->
        <div id="view-feedback" class="content-section">
            <div class="content-header">
                <h2>üìä View Student Feedback</h2>
                <button class="close-btn" onclick="closeContent()">‚Üê Back to Dashboard</button>
            </div>
            
            <div class="date-range">
                <div class="form-group">
                    <label for="report-mode">Report Type</label>
                    <select id="report-mode" onchange="onReportModeChange()">
                        <option value="daily">Daily (Select Date)</option>
                        <option value="weekly">Weekly (Select Week Date)</option>
                        <option value="monthly">Monthly (Select Month)</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>

                <div class="form-group" id="control-date">
                    <label for="feedback-date">Select Date</label>
                    <input type="date" id="feedback-date">
                </div>

                <div class="form-group" id="control-week" style="display:none;">
                    <label for="feedback-week-date">Week Date</label>
                    <input type="date" id="feedback-week-date">
                </div>

                <div class="form-group" id="control-month" style="display:none;">
                    <label for="feedback-month">Select Month</label>
                    <input type="month" id="feedback-month">
                </div>

                <div class="form-group" id="control-custom" style="display:none;">
                    <label>Custom Range</label>
                    <div style="display:flex; gap:8px;">
                        <input type="date" id="report-start">
                        <input type="date" id="report-end">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <button class="btn-action" onclick="generateFeedbackReport()">Search</button>
                    <button class="btn-secondary" onclick="exportFeedbackCSV()">Export CSV</button>
                    <button class="btn-secondary" onclick="exportFeedbackPDF()">Generate PDF</button>
                </div>
            </div>
            
            <div class="stats-row" id="feedback-stats"></div>
            
            <table class="feedback-table" id="feedback-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Student Name</th>
                        <th>Roll No</th>
                        <th>Breakfast Rating</th>
                        <th>Lunch Rating</th>
                        <th>Dinner Rating</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody id="feedback-body">
                    <tr>
                        <td colspan="7" style="text-align: center; color: #999;">No feedback available</td>
                    </tr>
                </tbody>
            </table>

            <div class="chart-row" id="feedback-charts-container" style="display:none;">
                <div class="chart-wrapper">
                    <h4>Meal-wise Average Ratings</h4>
                    <canvas id="mealRatingChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <h4>Rating Distribution</h4>
                    <canvas id="ratingDistributionChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Impose Fine Section -->
        <div id="impose-fine" class="content-section">
            <div class="content-header">
                <h2>‚öñÔ∏è Impose Fine</h2>
                <button class="close-btn" onclick="closeContent()">‚Üê Back to Dashboard</button>
            </div>
            
            <div id="success-msg-fine" class="success-msg"></div>
            
            <div class="form-section">
                <h3>Fine Details</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="fine-date">Date of Issue</label>
                        <input type="date" id="fine-date" required>
                    </div>
                    <div class="form-group">
                        <label for="fine-meal">Meal Affected</label>
                        <select id="fine-meal" required>
                            <option value="breakfast">Breakfast</option>
                            <option value="lunch">Lunch</option>
                            <option value="dinner">Dinner</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="fine-reason">Reason for Fine</label>
                    <select id="fine-reason" required>
                        <option value="">-- Select Reason --</option>
                        <option value="poor-quality">Poor Quality Food</option>
                        <option value="hygiene-issue">Hygiene Issue</option>
                        <option value="late-service">Late Service</option>
                        <option value="wrong-item">Wrong Item Served</option>
                        <option value="expired-food">Expired/Spoiled Food</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="fine-amount">Fine Amount (‚Çπ)</label>
                    <input type="number" id="fine-amount" min="0" step="100" placeholder="0" required>
                </div>
                <div class="form-group">
                    <label for="fine-imposed-by">Imposed By</label>
                    <select id="fine-imposed-by" required>
                        <option value="Chief Warden">Chief Warden</option>
                        <option value="Ao">Ao</option>
                        <option value="Mess Incharge">Mess Incharge</option>
                        <option value="Principal">Principal</option>
                    </select>
                </div>
            </div>
            
            <button class="btn-submit" onclick="imposeFine()">Impose Fine</button>
            
            <div class="form-section" style="margin-top: 30px;">
                <h3>View Fines Imposed</h3>
                
                <div class="date-range">
                    <div class="form-group">
                        <label for="fine-report-mode">Report Type</label>
                        <select id="fine-report-mode" onchange="onFineReportModeChange()">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>

                    <div class="form-group" id="fine-control-date">
                        <label for="fine-report-date">Select Date</label>
                        <input type="date" id="fine-report-date">
                    </div>

                    <div class="form-group" id="fine-control-week" style="display:none;">
                        <label for="fine-report-week-date">Week Date</label>
                        <input type="date" id="fine-report-week-date">
                    </div>

                    <div class="form-group" id="fine-control-month" style="display:none;">
                        <label for="fine-report-month">Select Month</label>
                        <input type="month" id="fine-report-month">
                    </div>

                    <div class="form-group" id="fine-control-custom" style="display:none;">
                        <label>Custom Range</label>
                        <div style="display:flex; gap:8px;">
                            <input type="date" id="fine-report-start">
                            <input type="date" id="fine-report-end">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <button class="btn-action" onclick="generateFineReport()">Search</button>
                        <button class="btn-secondary" onclick="exportFineCSV()">Export CSV</button>
                        <button class="btn-secondary" onclick="exportFinePDF()">Generate PDF</button>
                    </div>
                </div>

                <div class="stats-row" id="fine-report-stats"></div>
                
                <table class="feedback-table" id="fines-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Meal</th>
                            <th>Reason</th>
                            <th>Amount (‚Çπ)</th>
                            <th>Imposed By</th>
                            <th>Vendor Response</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="fines-body">
                        <tr>
                            <td colspan="7" style="text-align: center; color: #999;">No fines imposed yet</td>
                        </tr>
                    </tbody>
                </table>

                <div class="chart-row" id="fine-charts-container" style="display:none;">
                    <div class="chart-wrapper">
                        <h4>Fine Amount by Meal Type</h4>
                        <canvas id="fineByMealChart"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <h4>Fines by Reason</h4>
                        <canvas id="fineByReasonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let userData = null;
        let countBarChartInstance = null;
        let countPieChartInstance = null;
        let mealRatingChartInstance = null;
        let ratingDistributionChartInstance = null;
        let fineByMealChartInstance = null;
        let fineByReasonChartInstance = null;
        
        window.addEventListener('load', async () => {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user || user.role !== 'warden') {
                window.location.href = 'login.html';
                return;
            }
            
            userData = user;
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-greeting').textContent = user.username;
            
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];

            document.getElementById('count-date').value = tomorrow; // Default to tomorrow for adding counts
            document.getElementById('count-date').min = tomorrow; // Can only add for today onwards
            
            document.getElementById('feedback-date').value = today;
            document.getElementById('fine-date').value = today;

            document.getElementById('count-report-date').value = today;
            document.getElementById('count-report-week-date').value = today;
            document.getElementById('count-report-month').value = new Date().toISOString().slice(0, 7);
            document.getElementById('count-report-start').value = today;
            document.getElementById('count-report-end').value = today;

            document.getElementById('report-start').value = today;
            document.getElementById('report-end').value = today;

            document.getElementById('fine-report-date').value = today;
            document.getElementById('fine-report-week-date').value = today;
            document.getElementById('fine-report-month').value = new Date().toISOString().slice(0, 7);
            document.getElementById('fine-report-start').value = today;
            document.getElementById('fine-report-end').value = today;

            // Load initial data for recent displays
            await loadRecentFoodCounts();
            await loadRecentFines(); // Corrected to use API
        });
        
        function showContent(section) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function closeContent() {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
        }
        
        async function saveFoodCount() {
            const date = document.getElementById('count-date').value;
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            const studentBreakfast = parseInt(document.getElementById('student-breakfast').value) || 0;
            const studentLunch = parseInt(document.getElementById('student-lunch').value) || 0;
            const studentDinner = parseInt(document.getElementById('student-dinner').value) || 0;
            const facultyBreakfast = parseInt(document.getElementById('faculty-breakfast').value) || 0;
            const facultyLunch = parseInt(document.getElementById('faculty-lunch').value) || 0;
            const facultyDinner = parseInt(document.getElementById('faculty-dinner').value) || 0;

            const countsToSave = [
                { meal: 'breakfast', student_count: studentBreakfast, faculty_count: facultyBreakfast },
                { meal: 'lunch', student_count: studentLunch, faculty_count: facultyLunch },
                { meal: 'dinner', student_count: studentDinner, faculty_count: facultyDinner }
            ];

            let allSuccess = true;
            
            try {
                for (const item of countsToSave) {
                    const response = await fetch('/api/food-counts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            date: date,
                            meal: item.meal,
                            student_count: item.student_count,
                            faculty_count: item.faculty_count,
                            guest_count: 0
                        })
                    });
                    
                    if (!response.ok) {
                        allSuccess = false;
                        console.error(`Failed to save ${item.meal} count`);
                    }
                }
                
                if (allSuccess) {
                    const msg = document.getElementById('success-msg-count');
                    msg.textContent = '‚úì Food count saved successfully!';
                    msg.style.display = 'block';
                    setTimeout(() => msg.style.display = 'none', 3000);
                    
                    // Clear all input fields
                    document.getElementById('count-date').value = '';
                    document.getElementById('student-breakfast').value = '';
                    document.getElementById('student-lunch').value = '';
                    document.getElementById('student-dinner').value = '';
                    document.getElementById('faculty-breakfast').value = '';
                    document.getElementById('faculty-lunch').value = '';
                    document.getElementById('faculty-dinner').value = '';
                    
                    loadRecentFoodCounts(); // Refresh the table
                } else {
                    alert('Error saving some food counts. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving food counts: ' + error.message);
            }
        }
        
        async function loadRecentFoodCounts() {
            const tbody = document.getElementById('count-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">Loading food counts...</td></tr>';
            
            try {
                // Fetch food counts from today onwards for next 30 days
                const today = new Date();
                const start = today.toISOString().split('T')[0];
                const endDate = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
                const end = endDate.toISOString().split('T')[0];
                
                const response = await fetch(`/api/food-counts?start=${start}&end=${end}`);
                const foodCounts = await response.json();
                
                // Group by date to display combined breakfast, lunch, dinner totals
                const dailyAggregates = {};
                foodCounts.forEach(c => {
                    if (!dailyAggregates[c.date]) {
                        dailyAggregates[c.date] = { date: c.date, breakfast: 0, lunch: 0, dinner: 0 };
                    }
                    if (c.mealType === 'breakfast') dailyAggregates[c.date].breakfast = c.totalCount;
                    if (c.mealType === 'lunch') dailyAggregates[c.date].lunch = c.totalCount;
                    if (c.mealType === 'dinner') dailyAggregates[c.date].dinner = c.totalCount;
                });

                const sortedAggregates = Object.values(dailyAggregates).sort((a, b) => new Date(b.date) - new Date(a.date));

                if (sortedAggregates.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No food counts added yet</td></tr>';
                    return;
                }

                tbody.innerHTML = sortedAggregates.slice(0, 10).map((count, index) => {
                    const maxPeopleCount = Math.max(count.breakfast, count.lunch, count.dinner);
                    return `
                        <tr id="count-row-${index}">
                            <td>${new Date(count.date).toLocaleDateString('en-IN')}</td>
                            <td>${count.breakfast}</td>
                            <td>${count.lunch}</td>
                            <td>${count.dinner}</td>
                            <td><strong>${maxPeopleCount}</strong></td>
                            <td style="display: flex; gap: 5px;">
                                <button class="btn-edit" onclick="editCount('${count.date}')" title="Edit">‚úèÔ∏è</button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading food counts:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #dc3545;">Error loading food counts.</td></tr>';
            }
        }
        
        async function editCount(dateToEdit) {
            // For editing, we'd typically fetch the specific day's data, populate the form,
            // and then allow saving. This is a complex feature. For now, we will simulate
            // fetching the data from the (potentially local) storage, but a real implementation
            // would use a GET request for a specific date/meal and a PUT request to update.
            let counts = JSON.parse(localStorage.getItem('foodCounts') || '[]');
            const countForDate = counts.filter(c => c.date === dateToEdit);

            // Reconstruct the individual meal counts for the modal
            let breakfastData = countForDate.find(c => c.meal === 'breakfast') || { students: { breakfast: 0 }, faculty: { breakfast: 0 } };
            let lunchData = countForDate.find(c => c.meal === 'lunch') || { students: { lunch: 0 }, faculty: { lunch: 0 } };
            let dinnerData = countForDate.find(c => c.meal === 'dinner') || { students: { dinner: 0 }, faculty: { dinner: 0 } };

            const editHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000;" id="edit-modal-${dateToEdit}">
                    <div style="background: white; padding: 20px; border-radius: 15px; max-width: 600px; width: 100%; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">
                        <h3 style="text-align: center; font-size: 1.5rem; margin-bottom: 20px;">Edit Food Count - ${new Date(dateToEdit).toLocaleDateString('en-IN')}</h3>
                        <div style="margin-top: 20px;">
                            <h4 style="margin-bottom: 10px;">Students</h4>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                <div style="flex: 1; margin-right: 10px;">
                                    <label>Breakfast</label>
                                    <input type="number" id="edit-sb" value="${breakfastData.students.breakfast || 0}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                                </div>
                                <div style="flex: 1; margin-right: 10px;">
                                    <label>Lunch</label>
                                    <input type="number" id="edit-sl" value="${lunchData.students.lunch || 0}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                                </div>
                                <div style="flex: 1;">
                                    <label>Dinner</label>
                                    <input type="number" id="edit-sd" value="${dinnerData.students.dinner || 0}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                                </div>
                            </div>
                            <h4 style="margin-bottom: 10px;">Faculty</h4>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                <div style="flex: 1; margin-right: 10px;">
                                    <label>Breakfast</label>
                                    <input type="number" id="edit-fb" value="${breakfastData.faculty.breakfast || 0}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                                </div>
                                <div style="flex: 1; margin-right: 10px;">
                                    <label>Lunch</label>
                                    <input type="number" id="edit-fl" value="${lunchData.faculty.lunch || 0}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                                </div>
                                <div style="flex: 1;">
                                    <label>Dinner</label>
                                    <input type="number" id="edit-fd" value="${dinnerData.faculty.dinner || 0}" min="0" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeEditModal('${dateToEdit}')" style="padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">Cancel</button>
                            <button onclick="saveEditedCount('${dateToEdit}')" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">Save</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', editHTML);
        }
        
        function closeEditModal(date) {
            const modal = document.getElementById(`edit-modal-${date}`);
            if (modal) modal.remove();
        }
        
        async function saveEditedCount(date) {
            try {
                const breakfastStudent = parseInt(document.getElementById('edit-sb').value) || 0;
                const lunchStudent = parseInt(document.getElementById('edit-sl').value) || 0;
                const dinnerStudent = parseInt(document.getElementById('edit-sd').value) || 0;
                const breakfastFaculty = parseInt(document.getElementById('edit-fb').value) || 0;
                const lunchFaculty = parseInt(document.getElementById('edit-fl').value) || 0;
                const dinnerFaculty = parseInt(document.getElementById('edit-fd').value) || 0;
                
                const meals = [
                    { meal: 'breakfast', student_count: breakfastStudent, faculty_count: breakfastFaculty },
                    { meal: 'lunch', student_count: lunchStudent, faculty_count: lunchFaculty },
                    { meal: 'dinner', student_count: dinnerStudent, faculty_count: dinnerFaculty }
                ];
                
                let allSuccess = true;
                for (const item of meals) {
                    const response = await fetch('/api/food-counts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            date: date,
                            meal: item.meal,
                            student_count: item.student_count,
                            faculty_count: item.faculty_count,
                            guest_count: 0
                        })
                    });
                    
                    if (!response.ok) {
                        allSuccess = false;
                        console.error(`Failed to update ${item.meal} count`);
                    }
                }
                
                if (allSuccess) {
                    closeEditModal(date);
                    loadRecentFoodCounts(); // Refresh the displayed counts
                } else {
                    alert('Error updating some food counts. Please try again.');
                }
            } catch (error) {
                console.error('Error updating count:', error);
                alert('Error updating food count: ' + error.message);
            }
        }

        async function loadFeedback() {
            // This function is for initial load or general display based on current filter settings.
            // We use a predefined range (e.g., last 30 days) for initial load or use generateFeedbackReport()
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            const start = thirtyDaysAgo.toISOString().split('T')[0];
            const end = today.toISOString().split('T')[0];

            await generateFeedbackReport(start, end); // Use the report generator to load initial feedback
        }

        function onReportModeChange() {
            const mode = document.getElementById('report-mode').value;
            document.getElementById('control-date').style.display = mode === 'daily' ? '' : 'none';
            document.getElementById('control-week').style.display = mode === 'weekly' ? '' : 'none';
            document.getElementById('control-month').style.display = mode === 'monthly' ? '' : 'none';
            document.getElementById('control-custom').style.display = mode === 'custom' ? '' : 'none';
        }

        async function generateFeedbackReport(initialStart = null, initialEnd = null) {
            const mode = document.getElementById('report-mode').value;
            let start = initialStart, end = initialEnd;
            if (!initialStart || !initialEnd) { // Only calculate dates if not provided by initial call
                if (mode === 'daily') {
                    const d = document.getElementById('feedback-date').value;
                    if (!d) { alert('Select a date'); return; }
                    start = end = d;
                } else if (mode === 'weekly') {
                    const d = document.getElementById('feedback-week-date').value;
                    if (!d) { alert('Select a week date'); return; }
                    const dt = new Date(d);
                    const day = dt.getDay();
                    const diffToMonday = (day + 6) % 7;
                    const monday = new Date(dt);
                    monday.setDate(dt.getDate() - diffToMonday);
                    const sunday = new Date(monday);
                    sunday.setDate(monday.getDate() + 6);
                    start = monday.toISOString().slice(0,10);
                    end = sunday.toISOString().slice(0,10);
                } else if (mode === 'monthly') {
                    const m = document.getElementById('feedback-month').value;
                    if (!m) { alert('Select a month'); return; }
                    start = m + '-01';
                    const [yy, mm] = m.split('-').map(x => parseInt(x,10));
                    const lastDay = new Date(yy, mm, 0).getDate();
                    end = `${m}-${String(lastDay).padStart(2,'0')}`;
                } else if (mode === 'custom') {
                    const s = document.getElementById('report-start').value;
                    const e = document.getElementById('report-end').value;
                    if (!s || !e) { alert('Select start and end date'); return; }
                    if (s > e) { alert('Start date must be <= end date'); return; }
                    start = s; end = e;
                }
            }
            
            // Update the date fields so export can use them
            document.getElementById('report-start').value = start;
            document.getElementById('report-end').value = end;
            
            const tbody = document.getElementById('feedback-body');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Loading feedback...</td></tr>';
            document.getElementById('feedback-stats').innerHTML = '';
            document.getElementById('feedback-charts-container').style.display = 'none';

            try {
                const response = await fetch(`/api/feedback?start=${start}&end=${end}`);
                const filtered = await response.json();
                
                window.__filteredFeedback = filtered; // Store for CSV export

                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No feedback available</td></tr>';
                    return;
                }
                
                // Calculate stats - meal-wise average ratings
                let breakfastRatings = filtered.filter(f => f.breakfastRating).map(f => f.breakfastRating);
                let lunchRatings = filtered.filter(f => f.lunchRating).map(f => f.lunchRating);
                let dinnerRatings = filtered.filter(f => f.dinnerRating).map(f => f.dinnerRating);
                
                const avgBreakfast = breakfastRatings.length > 0 ? (breakfastRatings.reduce((a, b) => a + b, 0) / breakfastRatings.length).toFixed(1) : 0;
                const avgLunch = lunchRatings.length > 0 ? (lunchRatings.reduce((a, b) => a + b, 0) / lunchRatings.length).toFixed(1) : 0;
                const avgDinner = dinnerRatings.length > 0 ? (dinnerRatings.reduce((a, b) => a + b, 0) / dinnerRatings.length).toFixed(1) : 0;
                
                const stats = `
                    <div class="stat-box">
                        <div class="label">Total Feedbacks</div>
                        <div class="value">${filtered.length}</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Avg. Breakfast Rating</div>
                        <div class="value">${avgBreakfast}/5</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Avg. Lunch Rating</div>
                        <div class="value">${avgLunch}/5</div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Avg. Dinner Rating</div>
                        <div class="value">${avgDinner}/5</div>
                    </div>
                `;
                document.getElementById('feedback-stats').innerHTML = stats;
                
                tbody.innerHTML = filtered.map(f => `
                    <tr>
                        <td>${new Date(f.date).toLocaleDateString('en-IN')}</td>
                        <td>${f.studentName || '-'}</td>
                        <td>${f.rollNumber || '-'}</td>
                        <td><span class="rating-badge">${f.breakfastRating || '-'}/5</span></td>
                        <td><span class="rating-badge">${f.lunchRating || '-'}/5</span></td>
                        <td><span class="rating-badge">${f.dinnerRating || '-'}/5</span></td>
                        <td>${f.comments || '-'}</td>
                    </tr>
                `).join('');
                renderFeedbackCharts(filtered);

            } catch (error) {
                console.error('Error generating feedback report:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #dc3545;">Error loading feedback report.</td></tr>';
                document.getElementById('feedback-stats').innerHTML = '';
                document.getElementById('feedback-charts-container').style.display = 'none';
            }
        }

        function renderFeedbackCharts(data) {
            if (!data || data.length === 0) {
                document.getElementById('feedback-charts-container').style.display = 'none';
                return;
            }
            
            document.getElementById('feedback-charts-container').style.display = 'grid';

            // Meal-wise average ratings
            let breakfastRatings = data.filter(f => f.breakfastRating).map(f => f.breakfastRating);
            let lunchRatings = data.filter(f => f.lunchRating).map(f => f.lunchRating);
            let dinnerRatings = data.filter(f => f.dinnerRating).map(f => f.dinnerRating);
            
            const avgBreakfast = breakfastRatings.length > 0 ? (breakfastRatings.reduce((a, b) => a + b, 0) / breakfastRatings.length) : 0;
            const avgLunch = lunchRatings.length > 0 ? (lunchRatings.reduce((a, b) => a + b, 0) / lunchRatings.length) : 0;
            const avgDinner = dinnerRatings.length > 0 ? (dinnerRatings.reduce((a, b) => a + b, 0) / dinnerRatings.length) : 0;

            // Bar chart for meal ratings
            const mealCtx = document.getElementById('mealRatingChart').getContext('2d');
            if (mealRatingChartInstance) mealRatingChartInstance.destroy();
            mealRatingChartInstance = new Chart(mealCtx, {
                type: 'bar',
                data: {
                    labels: ['Breakfast', 'Lunch', 'Dinner'],
                    datasets: [{
                        label: 'Average Rating (out of 5)',
                        data: [avgBreakfast.toFixed(2), avgLunch.toFixed(2), avgDinner.toFixed(2)],
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb'],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: {
                        y: { beginAtZero: true, max: 5 }
                    }
                }
            });

            // Pie chart for rating distribution
            const allRatings = [...breakfastRatings, ...lunchRatings, ...dinnerRatings];
            const ratingCounts = {
                '5': allRatings.filter(r => r === 5).length,
                '4': allRatings.filter(r => r === 4).length,
                '3': allRatings.filter(r => r === 3).length,
                '2': allRatings.filter(r => r === 2).length,
                '1': allRatings.filter(r => r === 1).length,
            };

            const ratingCtx = document.getElementById('ratingDistributionChart').getContext('2d');
            if (ratingDistributionChartInstance) ratingDistributionChartInstance.destroy();
            ratingDistributionChartInstance = new Chart(ratingCtx, {
                type: 'pie',
                data: {
                    labels: ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'],
                    datasets: [{
                        data: [ratingCounts['5'], ratingCounts['4'], ratingCounts['3'], ratingCounts['2'], ratingCounts['1']],
                        backgroundColor: ['#28a745', '#20c997', '#ffc107', '#fd7e14', '#dc3545'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: true, position: 'right' } }
                }
            });
        }

        async function exportFeedbackCSV() {
            let currentStart = document.getElementById('report-start').value;
            let currentEnd = document.getElementById('report-end').value;
            
            if (!currentStart || !currentEnd) {
                alert('Please generate a report first and select a date range');
                return;
            }
            
            try {
                // Fetch feedback data for the selected range
                const response = await fetch(`/api/feedback?start=${currentStart}&end=${currentEnd}`);
                const feedbackData = await response.json();
                
                console.log(`Exporting feedback: ${feedbackData.length} records found`);
                
                if (feedbackData.length === 0) {
                    alert('No data available for the selected date range');
                    return;
                }
                
                // Generate CSV content
                let csvContent = 'Date,Student Name,Roll Number,Breakfast Rating,Lunch Rating,Dinner Rating,Comments\n';
                
                feedbackData.forEach(row => {
                    const date = new Date(row.date).toLocaleDateString('en-IN');
                    const name = row.studentName || '-';
                    const rollNo = row.rollNumber || '-';
                    const breakfast = row.breakfastRating || '-';
                    const lunch = row.lunchRating || '-';
                    const dinner = row.dinnerRating || '-';
                    const comments = (row.comments || '-').replace(/,/g, ' '); // Remove commas from comments
                    
                    csvContent += `"${date}","${name}","${rollNo}",${breakfast},${lunch},${dinner},"${comments}"\n`;
                });
                
                // Create blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `feedback_${currentStart}_to_${currentEnd}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('CSV exported successfully');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV: ' + error.message);
            }
        }

        async function exportFeedbackPDF() {
            const start = document.getElementById('report-start').value;
            const end = document.getElementById('report-end').value;
            if (!start || !end) { alert('Please generate a report first and select a date range'); return; }

            const collegeName = _getCollegeName();
            const wrapper = document.createElement('div');
            wrapper.style.padding = '18px';
            wrapper.style.fontFamily = 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif';

            const header = document.createElement('div');
            header.innerHTML = `<div style="text-align:center; margin-bottom:8px;"><h2 style="margin:0">${collegeName}</h2><h3 style="margin:0; font-weight:400">Student Feedback Report (${start} to ${end})</h3><hr/></div>`;
            wrapper.appendChild(header);

            // Clone feedback table
            const table = document.getElementById('feedback-table');
            if (table) wrapper.appendChild(table.cloneNode(true));

            // Charts omitted from PDF export (per request)

            const opt = {
                margin: 0.5,
                filename: `feedback_${start}_to_${end}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(wrapper).save();
        }

        
        async function imposeFine() {
            const date = document.getElementById('fine-date').value;
            const reason = document.getElementById('fine-reason').value;
            const amount = document.getElementById('fine-amount').value;
            const meal = document.getElementById('fine-meal').value;
            const imposedBy = document.getElementById('fine-imposed-by') ? document.getElementById('fine-imposed-by').value : userData.username;

            if (!date || !reason || !amount || !imposedBy) {
                alert('Please fill all required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/fines', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: date,
                        reason: reason,
                        amount: parseInt(amount),
                        meal: meal,
                        imposedBy: imposedBy
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('Error imposing fine: ' + (error.error || 'Unknown error'));
                    return;
                }
                
                const msg = document.getElementById('success-msg-fine');
                msg.textContent = '‚úì Fine imposed successfully!';
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
                
                // Clear form
                document.getElementById('fine-reason').value = '';
                document.getElementById('fine-amount').value = '';
                document.getElementById('fine-date').value = '';
                if (document.getElementById('fine-imposed-by')) document.getElementById('fine-imposed-by').selectedIndex = 0;
                
                loadRecentFines(); // Refresh the fines table
            } catch (error) {
                console.error('Error imposing fine:', error);
                alert('Error imposing fine: ' + error.message);
            }
        }

        async function deleteFine(fineId) {
            if (!confirm('Are you sure you want to delete this fine?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/fines/${fineId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    alert('Error deleting fine: ' + (error.error || 'Unknown error'));
                    return;
                }
                
                // Show success message
                const tbody = document.getElementById('fines-body');
                const msg = document.createElement('div');
                msg.className = 'success-msg';
                msg.style.display = 'block';
                msg.style.position = 'fixed';
                msg.style.top = '20px';
                msg.style.right = '20px';
                msg.style.zIndex = '1000';
                msg.textContent = '‚úì Fine deleted successfully!';
                document.body.appendChild(msg);
                setTimeout(() => msg.remove(), 3000);
                
                // Refresh the fines table
                loadRecentFines();
            } catch (error) {
                console.error('Error deleting fine:', error);
                alert('Error deleting fine: ' + error.message);
            }
        }
        
        async function loadRecentFines() { // Renamed from loadFines to avoid conflicts with global variable
            const tbody = document.getElementById('fines-body');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Loading fines...</td></tr>';

            try {
                // Fetch fines from today onwards for next 30 days
                const today = new Date();
                const start = today.toISOString().split('T')[0];
                const endDate = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
                const end = endDate.toISOString().split('T')[0];
                
                const finesResponse = await fetch(`/api/fines?start=${start}&end=${end}`);
                const fines = await finesResponse.json();
                
                const vendorResponsesResponse = await fetch('/api/vendor-responses');
                const vendorResponses = await vendorResponsesResponse.json();

                if (fines.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No fines imposed yet</td></tr>';
                    document.getElementById('fine-report-stats').innerHTML = '';
                    document.getElementById('fine-charts-container').style.display = 'none';
                    return;
                }
                
                tbody.innerHTML = fines.slice(0, 10).map(fine => {
                    // Find corresponding vendor response using fine_id (DB column name)
                    const response = vendorResponses.find(r => r.fine_id === fine.id);
                    const responseText = response ? response.vendor_response : '<span style="color: #999;">No response yet</span>';
                    
                    return `
                        <tr>
                            <td>${new Date(fine.date).toLocaleDateString('en-IN')}</td>
                            <td style="text-transform: capitalize;">${fine.meal}</td>
                            <td>${fine.reason.replace(/-/g, ' ')}</td>
                            <td>‚Çπ${fine.amount}</td>
                            <td>${fine.imposedBy || ''}</td>
                            <td>${responseText}</td>
                            <td>
                                <button class="btn-delete" onclick="deleteFine(${fine.id})" title="Delete fine">
                                    <span style="color: #dc3545;">‚úï Delete</span>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading fines:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #dc3545;">Error loading fines.</td></tr>';
            }
        }

        function onFineReportModeChange() {
            const mode = document.getElementById('fine-report-mode').value;
            document.getElementById('fine-control-date').style.display = mode === 'daily' ? '' : 'none';
            document.getElementById('fine-control-week').style.display = mode === 'weekly' ? '' : 'none';
            document.getElementById('fine-control-month').style.display = mode === 'monthly' ? '' : 'none';
            document.getElementById('fine-control-custom').style.display = mode === 'custom' ? '' : 'none';
        }

        async function generateFineReport() {
            const mode = document.getElementById('fine-report-mode').value;
            let start = null, end = null;
            
            if (mode === 'daily') {
                const d = document.getElementById('fine-report-date').value;
                if (!d) { alert('Select a date'); return; }
                start = end = d;
            } else if (mode === 'weekly') {
                const d = document.getElementById('fine-report-week-date').value;
                if (!d) { alert('Select a week date'); return; }
                const dt = new Date(d);
                const day = dt.getDay();
                const diffToMonday = (day + 6) % 7;
                const monday = new Date(dt);
                monday.setDate(dt.getDate() - diffToMonday);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                start = monday.toISOString().slice(0,10);
                end = sunday.toISOString().slice(0,10);
            } else if (mode === 'monthly') {
                const m = document.getElementById('fine-report-month').value;
                if (!m) { alert('Select a month'); return; }
                start = m + '-01';
                const [yy, mm] = m.split('-').map(x => parseInt(x,10));
                const lastDay = new Date(yy, mm, 0).getDate();
                end = `${m}-${String(lastDay).padStart(2,'0')}`;
            } else if (mode === 'custom') {
                const s = document.getElementById('fine-report-start').value;
                const e = document.getElementById('fine-report-end').value;
                if (!s || !e) { alert('Select start and end date'); return; }
                if (s > e) { alert('Start date must be <= end date'); return; }
                start = s; end = e;
            }

            // Update the date fields so export can use them
            document.getElementById('fine-report-start').value = start;
            document.getElementById('fine-report-end').value = end;

            const tbody = document.getElementById('fines-body');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">Loading fine report...</td></tr>';
            document.getElementById('fine-report-stats').innerHTML = '';
            document.getElementById('fine-charts-container').style.display = 'none';

            try {
                const finesResponse = await fetch(`/api/fines?start=${start}&end=${end}`);
                const filteredFines = await finesResponse.json();
                
                const vendorResponsesResponse = await fetch('/api/vendor-responses');
                const vendorResponses = await vendorResponsesResponse.json();

                window.__filteredFineData = filteredFines; // Store for CSV export
                renderFineReport(filteredFines, vendorResponses);

            } catch (error) {
                console.error('Error generating fine report:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #dc3545;">Error loading fine report.</td></tr>';
                document.getElementById('fine-report-stats').innerHTML = '';
                document.getElementById('fine-charts-container').style.display = 'none';
            }
        }

        function renderFineReport(data, vendorResponses) {
            if (!data || data.length === 0) {
                document.getElementById('fines-body').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No fines for selected period</td></tr>';
                document.getElementById('fine-report-stats').innerHTML = '';
                document.getElementById('fine-charts-container').style.display = 'none';
                return;
            }

            // Calculate stats
            const totalAmount = data.reduce((sum, f) => sum + f.amount, 0);
            const avgAmount = data.length > 0 ? (totalAmount / data.length).toFixed(0) : 0;
            const breakfastFines = data.filter(f => f.meal === 'breakfast').length;
            const lunchFines = data.filter(f => f.meal === 'lunch').length;
            const dinnerFines = data.filter(f => f.meal === 'dinner').length;

            const stats = `
                <div class="stat-box">
                    <div class="label">Total Fines</div>
                    <div class="value">${data.length}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Total Amount</div>
                    <div class="value">‚Çπ${totalAmount}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Average Fine</div>
                    <div class="value">‚Çπ${avgAmount}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Most Fined Meal</div>
                    <div class="value">${breakfastFines >= lunchFines && breakfastFines >= dinnerFines ? 'Breakfast' : lunchFines >= dinnerFines ? 'Lunch' : 'Dinner'}</div>
                </div>
            `;
            document.getElementById('fine-report-stats').innerHTML = stats;

            document.getElementById('fines-body').innerHTML = data.map(fine => {
                const response = vendorResponses.find(r => r.fine_id === fine.id);
                const responseText = response ? response.vendor_response : '<span style="color: #999;">No response yet</span>';
                
                return `
                    <tr>
                        <td>${new Date(fine.date).toLocaleDateString('en-IN')}</td>
                        <td style="text-transform: capitalize;">${fine.meal}</td>
                        <td>${fine.reason.replace(/-/g, ' ')}</td>
                        <td>‚Çπ${fine.amount}</td>
                        <td>${responseText}</td>
                        <td>
                            <button class="btn-delete" onclick="deleteFine(${fine.id})" title="Delete fine">
                                <span style="color: #dc3545;">‚úï Delete</span>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            renderFineCharts(data);
        }

        function renderFineCharts(data) {
            if (!data || data.length === 0) {
                document.getElementById('fine-charts-container').style.display = 'none';
                return;
            }

            document.getElementById('fine-charts-container').style.display = 'grid';

            // Meal-wise fine amounts
            const breakfastAmount = data.filter(f => f.meal === 'breakfast').reduce((sum, f) => sum + f.amount, 0);
            const lunchAmount = data.filter(f => f.meal === 'lunch').reduce((sum, f) => sum + f.amount, 0);
            const dinnerAmount = data.filter(f => f.meal === 'dinner').reduce((sum, f) => sum + f.amount, 0);

            const mealCtx = document.getElementById('fineByMealChart').getContext('2d');
            if (fineByMealChartInstance) fineByMealChartInstance.destroy();
            fineByMealChartInstance = new Chart(mealCtx, {
                type: 'bar',
                data: {
                    labels: ['Breakfast', 'Lunch', 'Dinner'],
                    datasets: [{
                        label: 'Total Fine Amount (‚Çπ)',
                        data: [breakfastAmount, lunchAmount, dinnerAmount],
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb'],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Fines by reason - pie chart
            const reasonCounts = {};
            data.forEach(f => {
                const reason = f.reason.replace(/-/g, ' ');
                reasonCounts[reason] = (reasonCounts[reason] || 0) + f.amount;
            });

            const reasonCtx = document.getElementById('fineByReasonChart').getContext('2d');
            if (fineByReasonChartInstance) fineByReasonChartInstance.destroy();
            fineByReasonChartInstance = new Chart(reasonCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(reasonCounts),
                    datasets: [{
                        data: Object.values(reasonCounts),
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#ff6b6b', '#ffc107', '#20c997'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: true, position: 'right' } }
                }
            });
        }

        async function exportFineCSV() {
            let currentStart = document.getElementById('fine-report-start').value;
            let currentEnd = document.getElementById('fine-report-end').value;
            
            if (!currentStart || !currentEnd) {
                alert('Please generate a report first and select a date range');
                return;
            }
            
            try {
                // Fetch fines data for the selected range
                const response = await fetch(`/api/fines?start=${currentStart}&end=${currentEnd}`);
                const finesData = await response.json();
                
                console.log(`Exporting fines: ${finesData.length} records found`);
                
                if (finesData.length === 0) {
                    alert('No data available for the selected date range');
                    return;
                }
                
                // Generate CSV content
                let csvContent = 'Date,Meal,Reason,Amount (‚Çπ),Imposed By\n';
                
                finesData.forEach(row => {
                    const date = new Date(row.date).toLocaleDateString('en-IN');
                    const meal = row.meal || '-';
                    const reason = (row.reason || '-').replace(/,/g, ' ').replace(/-/g, ' ');
                    const amount = row.amount || 0;
                    const imposedBy = row.imposedBy || '-';
                    
                    csvContent += `"${date}","${meal}","${reason}",${amount},"${imposedBy}"\n`;
                });
                
                // Create blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `fines_${currentStart}_to_${currentEnd}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('CSV exported successfully');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV: ' + error.message);
            }
        }

        async function exportFinePDF() {
            const start = document.getElementById('fine-report-start').value;
            const end = document.getElementById('fine-report-end').value;
            if (!start || !end) { alert('Please generate a report first and select a date range'); return; }

            const collegeName = _getCollegeName();
            const wrapper = document.createElement('div');
            wrapper.style.padding = '18px';
            wrapper.style.fontFamily = 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif';

            const header = document.createElement('div');
            header.innerHTML = `<div style="text-align:center; margin-bottom:8px;"><h2 style="margin:0">${collegeName}</h2><h3 style="margin:0; font-weight:400">Fine Report (${start} to ${end})</h3><hr/></div>`;
            wrapper.appendChild(header);

            // Clone fines table
            const table = document.getElementById('fines-table');
            if (table) wrapper.appendChild(table.cloneNode(true));

            // Charts omitted from PDF export (per request)

            const opt = {
                margin: 0.5,
                filename: `fines_${start}_to_${end}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(wrapper).save();
        }
        
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        // ===== FOOD COUNT REPORT FUNCTIONS =====
        function onCountReportModeChange() {
            const mode = document.getElementById('count-report-mode').value;
            document.getElementById('count-control-date').style.display = mode === 'daily' ? '' : 'none';
            document.getElementById('count-control-week').style.display = mode === 'weekly' ? '' : 'none';
            document.getElementById('count-control-month').style.display = mode === 'monthly' ? '' : 'none';
            document.getElementById('count-control-custom').style.display = mode === 'custom' ? '' : 'none';
        }

        async function generateCountReport() {
            const mode = document.getElementById('count-report-mode').value;
            let start = null, end = null;
            if (mode === 'daily') {
                const d = document.getElementById('count-report-date').value;
                if (!d) { alert('Select a date'); return; }
                start = end = d;
            } else if (mode === 'weekly') {
                const d = document.getElementById('count-report-week-date').value;
                if (!d) { alert('Select a week date'); return; }
                const dt = new Date(d);
                const day = dt.getDay();
                const diffToMonday = (day + 6) % 7;
                const monday = new Date(dt);
                monday.setDate(dt.getDate() - diffToMonday);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                start = monday.toISOString().slice(0,10);
                end = sunday.toISOString().slice(0,10);
            } else if (mode === 'monthly') {
                const m = document.getElementById('count-report-month').value;
                if (!m) { alert('Select a month'); return; }
                start = m + '-01';
                const [yy, mm] = m.split('-').map(x => parseInt(x,10));
                const lastDay = new Date(yy, mm, 0).getDate();
                end = `${m}-${String(lastDay).padStart(2,'0')}`;
            } else if (mode === 'custom') {
                const s = document.getElementById('count-report-start').value;
                const e = document.getElementById('count-report-end').value;
                if (!s || !e) { alert('Select start and end date'); return; }
                if (s > e) { alert('Start date must be <= end date'); return; }
                start = s; end = e;
            }

            // Update the hidden date fields so export can use them
            document.getElementById('count-report-start').value = start;
            document.getElementById('count-report-end').value = end;

            const tbody = document.getElementById('count-report-body');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">Loading food count report...</td></tr>';
            document.getElementById('count-report-stats').innerHTML = '';
            document.getElementById('count-charts-container').style.display = 'none';

            try {
                const response = await fetch(`/api/food-counts?start=${start}&end=${end}`);
                const foodCounts = await response.json();
                
                // Aggregate by date
                const dailyAggregates = {};
                foodCounts.forEach(c => {
                    if (!dailyAggregates[c.date]) {
                        dailyAggregates[c.date] = { date: c.date, breakfast: 0, lunch: 0, dinner: 0, maxPeople: 0 };
                    }
                    if (c.mealType === 'breakfast') dailyAggregates[c.date].breakfast = c.totalCount;
                    if (c.mealType === 'lunch') dailyAggregates[c.date].lunch = c.totalCount;
                    if (c.mealType === 'dinner') dailyAggregates[c.date].dinner = c.totalCount;
                });
                
                const transformedData = Object.values(dailyAggregates).map(data => {
                    data.maxPeople = Math.max(data.breakfast, data.lunch, data.dinner);
                    return data;
                }).sort((a,b) => new Date(a.date) - new Date(b.date)); // Sort by date ascending for charts

                window.__filteredCountData = transformedData; // Store for CSV export
                renderCountReport(transformedData);

            } catch (error) {
                console.error('Error generating count report:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #dc3545;">Error loading food count report.</td></tr>';
                document.getElementById('count-report-stats').innerHTML = '';
                document.getElementById('count-charts-container').style.display = 'none';
            }
        }

        function renderCountReport(data) {
            if (!data || data.length === 0) {
                document.getElementById('count-report-body').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No food count data available</td></tr>';
                document.getElementById('count-report-stats').innerHTML = '';
                document.getElementById('count-charts-container').style.display = 'none';
                return;
            }

            // Calculate stats
            let totalBreakfast = 0, totalLunch = 0, totalDinner = 0, totalMaxPeople = 0;
            data.forEach(r => {
                totalBreakfast += r.breakfast || 0;
                totalLunch += r.lunch || 0;
                totalDinner += r.dinner || 0;
                totalMaxPeople += r.maxPeople || 0;
            });

            const avgBreakfast = data.length > 0 ? (totalBreakfast / data.length).toFixed(0) : 0;
            const avgLunch = data.length > 0 ? (totalLunch / data.length).toFixed(0) : 0;
            const avgDinner = data.length > 0 ? (totalDinner / data.length).toFixed(0) : 0;

            const stats = `
                <div class="stat-box">
                    <div class="label">Total Records</div>
                    <div class="value">${data.length}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Avg Breakfast Count</div>
                    <div class="value">${avgBreakfast}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Avg Lunch Count</div>
                    <div class="value">${avgLunch}</div>
                </div>
                <div class="stat-box">
                    <div class="label">Avg Dinner Count</div>
                    <div class="value">${avgDinner}</div>
                </div>
            `;
            document.getElementById('count-report-stats').innerHTML = stats;

            document.getElementById('count-report-body').innerHTML = data.map(r => `
                <tr>
                    <td>${new Date(r.date).toLocaleDateString('en-IN')}</td>
                    <td>${r.breakfast}</td>
                    <td>${r.lunch}</td>
                    <td>${r.dinner}</td>
                    <td><strong>${r.maxPeople}</strong></td>
                </tr>
            `).join('');

            renderCountCharts(data);
        }

        function renderCountCharts(data) {
            if (!data || data.length === 0) return;

            document.getElementById('count-charts-container').style.display = 'grid';

            // Bar chart for daily food counts
            const dates = data.map(d => new Date(d.date).toLocaleDateString('en-IN'));
            const breakfastData = data.map(d => d.breakfast);
            const lunchData = data.map(d => d.lunch);
            const dinnerData = data.map(d => d.dinner);

            const barCtx = document.getElementById('countBarChart').getContext('2d');
            if (countBarChartInstance) countBarChartInstance.destroy();
            countBarChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Breakfast',
                            data: breakfastData,
                            backgroundColor: '#667eea'
                        },
                        {
                            label: 'Lunch',
                            data: lunchData,
                            backgroundColor: '#764ba2'
                        },
                        {
                            label: 'Dinner',
                            data: dinnerData,
                            backgroundColor: '#f093fb'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Pie chart for meal-wise average
            const avgBreakfast = breakfastData.length > 0 ? (breakfastData.reduce((a, b) => a + b, 0) / breakfastData.length).toFixed(0) : 0;
            const avgLunch = lunchData.length > 0 ? (lunchData.reduce((a, b) => a + b, 0) / lunchData.length).toFixed(0) : 0;
            const avgDinner = dinnerData.length > 0 ? (dinnerData.reduce((a, b) => a + b, 0) / dinnerData.length).toFixed(0) : 0;

            const pieCtx = document.getElementById('countPieChart').getContext('2d');
            if (countPieChartInstance) countPieChartInstance.destroy();
            countPieChartInstance = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ['Breakfast', 'Lunch', 'Dinner'],
                    datasets: [{
                        data: [avgBreakfast, avgLunch, avgDinner],
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: true, position: 'right' } }
                }
            });
        }

        async function exportCountCSV() {
            let currentStart = document.getElementById('count-report-start').value;
            let currentEnd = document.getElementById('count-report-end').value;
            
            if (!currentStart || !currentEnd) {
                alert('Please generate a report first and select a date range');
                return;
            }
            
            try {
                // Fetch data for the selected range
                const response = await fetch(`/api/food-counts?start=${currentStart}&end=${currentEnd}`);
                const foodCounts = await response.json();
                
                console.log(`Exporting food counts: ${foodCounts.length} records found`);
                
                if (foodCounts.length === 0) {
                    alert('No data available for the selected date range');
                    return;
                }
                
                // Aggregate data by date for CSV export
                const dailyAggregates = {};
                foodCounts.forEach(c => {
                    if (!dailyAggregates[c.date]) {
                        dailyAggregates[c.date] = { 
                            date: c.date, 
                            breakfast: 0, 
                            lunch: 0, 
                            dinner: 0,
                            breakfastStudents: 0,
                            breakfastFaculty: 0,
                            lunchStudents: 0,
                            lunchFaculty: 0,
                            dinnerStudents: 0,
                            dinnerFaculty: 0
                        };
                    }
                    if (c.mealType === 'breakfast') {
                        dailyAggregates[c.date].breakfast = c.totalCount;
                        dailyAggregates[c.date].breakfastStudents = c.studentCount;
                        dailyAggregates[c.date].breakfastFaculty = c.facultyCount;
                    }
                    if (c.mealType === 'lunch') {
                        dailyAggregates[c.date].lunch = c.totalCount;
                        dailyAggregates[c.date].lunchStudents = c.studentCount;
                        dailyAggregates[c.date].lunchFaculty = c.facultyCount;
                    }
                    if (c.mealType === 'dinner') {
                        dailyAggregates[c.date].dinner = c.totalCount;
                        dailyAggregates[c.date].dinnerStudents = c.studentCount;
                        dailyAggregates[c.date].dinnerFaculty = c.facultyCount;
                    }
                });
                
                // Generate CSV content
                let csvContent = 'Date,Breakfast Total,Breakfast Students,Breakfast Faculty,Lunch Total,Lunch Students,Lunch Faculty,Dinner Total,Dinner Students,Dinner Faculty,Maximum People Fed\n';
                
                Object.values(dailyAggregates).sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(row => {
                    const maxPeople = Math.max(row.breakfast, row.lunch, row.dinner);
                    csvContent += `${new Date(row.date).toLocaleDateString('en-IN')},${row.breakfast},${row.breakfastStudents},${row.breakfastFaculty},${row.lunch},${row.lunchStudents},${row.lunchFaculty},${row.dinner},${row.dinnerStudents},${row.dinnerFaculty},${maxPeople}\n`;
                });
                
                // Create blob and download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `food_counts_${currentStart}_to_${currentEnd}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('CSV exported successfully');
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV: ' + error.message);
            }
        }

        // ===== PDF Export Helpers =====
        function _getCollegeName() {
            try {
                return (userData && userData.collegeName) ? userData.collegeName : document.title || 'CMC Mess Management';
            } catch (e) { return 'CMC Mess Management'; }
        }

        // Chart-to-image helper removed ‚Äî charts are intentionally excluded from PDF exports.

        async function exportCountPDF() {
            const start = document.getElementById('count-report-start').value;
            const end = document.getElementById('count-report-end').value;
            if (!start || !end) { alert('Please generate a report first and select a date range'); return; }

            const collegeName = _getCollegeName();
            const wrapper = document.createElement('div');
            wrapper.style.padding = '18px';
            wrapper.style.fontFamily = 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif';

            const header = document.createElement('div');
            header.innerHTML = `<div style="text-align:center; margin-bottom:8px;"><h2 style="margin:0">${collegeName}</h2><h3 style="margin:0; font-weight:400">Food Count Report (${start} to ${end})</h3><hr/></div>`;
            wrapper.appendChild(header);

            // Clone table
            const table = document.getElementById('count-report-table');
            if (table) wrapper.appendChild(table.cloneNode(true));

            // Charts omitted from PDF export (per request)

            const opt = {
                margin: 0.5,
                filename: `food_counts_${start}_to_${end}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(wrapper).save();
        }


        // Renamed/merged functions to ensure API calls are used
        window.addEventListener('load', async () => {
            // ... (existing load logic) ...
            await loadRecentFoodCounts(); // Loads recent food counts from API
            await loadFeedback(); // Loads recent feedback from API
            await loadRecentFines(); // Loads recent fines from API
            // Initial load of food quality is implicit with feedback charts or could be explicitly added
            // to a specific section if a separate food quality display is desired outside of feedback reports.
        });
        
    </script>
</body>
</html>